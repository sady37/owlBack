# Auth Service vs æ—§ Handler ä¸šåŠ¡é€»è¾‘å¯¹æ¯”

## ğŸ“‹ å¯¹æ¯”åˆ†æ

### 1. POST /auth/api/v1/login å¯¹æ¯”

#### 1.1 å‚æ•°è§£æï¼ˆ15-87è¡Œï¼‰

**æ—§ Handler é€»è¾‘**ï¼ˆauth_handlers.go:15-87ï¼‰ï¼š
1. âœ… **æ”¯æŒå¤šç§å‚æ•°æ ¼å¼**ï¼š
   - ä» JSON Body è·å–å‚æ•°
   - æ”¯æŒ `{params: {...}}` åŒ…è£…æ ¼å¼
   - ä» Query å‚æ•°è·å–ï¼ˆfallbackï¼‰
   - å‚æ•°ä¼˜å…ˆçº§ï¼šBody > Query

2. âœ… **å‚æ•°åˆ—è¡¨**ï¼š
   - `tenant_id` (string, å¯é€‰)
   - `userType` (string, å¯é€‰ï¼Œé»˜è®¤ä¸º "staff")
   - `accountHash` (string, å¿…å¡«)
   - `passwordHash` (string, å¿…å¡«)

3. âœ… **å‚æ•°éªŒè¯**ï¼š
   - `accountHash` ä¸èƒ½ä¸ºç©º
   - `passwordHash` ä¸èƒ½ä¸ºç©º
   - å¦‚æœä¸ºç©ºï¼Œè®°å½•è­¦å‘Šæ—¥å¿—å¹¶è¿”å› "missing credentials"

4. âœ… **å‚æ•°è§„èŒƒåŒ–**ï¼š
   - `userType` è½¬æ¢ä¸ºå°å†™å¹¶ trim
   - å¦‚æœä¸ºç©ºï¼Œé»˜è®¤ä¸º "staff"
   - `accountHash` å’Œ `passwordHash` éƒ½ trim

**æ–° Service é€»è¾‘**ï¼ˆauth_service.go:48-80ï¼‰ï¼š
1. âš ï¸ **å‚æ•°æ ¼å¼**ï¼šHandler å±‚å¤„ç†ï¼ˆä¸åœ¨ Service å±‚ï¼‰
2. âœ… **å‚æ•°éªŒè¯**ï¼šå·²å®ç°ï¼ˆaccountHash å’Œ passwordHash å¿…å¡«ï¼‰
3. âœ… **å‚æ•°è§„èŒƒåŒ–**ï¼šå·²å®ç°ï¼ˆuserType è§„èŒƒåŒ–ï¼ŒaccountHash å’Œ passwordHash trimï¼‰
4. âœ… **æ—¥å¿—è®°å½•**ï¼šå·²å®ç°ï¼ˆè®°å½•è­¦å‘Šæ—¥å¿—ï¼‰

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… å‚æ•°éªŒè¯é€»è¾‘ä¸€è‡´
- âœ… å‚æ•°è§„èŒƒåŒ–é€»è¾‘ä¸€è‡´
- âœ… æ—¥å¿—è®°å½•é€»è¾‘ä¸€è‡´
- âœ… å‚æ•°æ ¼å¼å¤„ç†åœ¨ Handler å±‚ï¼ˆç¬¦åˆèŒè´£è¾¹ç•Œï¼‰

---

#### 1.2 Hash è§£ç å’ŒéªŒè¯ï¼ˆ94-126è¡Œï¼‰

**æ—§ Handler é€»è¾‘**ï¼ˆauth_handlers.go:94-126ï¼‰ï¼š
1. âœ… **Hex è§£ç **ï¼š
   - `accountHash` ä» hex å­—ç¬¦ä¸²è§£ç ä¸º `[]byte`
   - `passwordHash` ä» hex å­—ç¬¦ä¸²è§£ç ä¸º `[]byte`
   - å¦‚æœè§£ç å¤±è´¥æˆ–é•¿åº¦ä¸º 0ï¼Œè®°å½•è­¦å‘Šæ—¥å¿—å¹¶è¿”å› "invalid credentials"

**æ–° Service é€»è¾‘**ï¼ˆauth_service.go:82-108ï¼‰ï¼š
1. âœ… **Hex è§£ç **ï¼šå·²å®ç°ï¼ˆaccountHash å’Œ passwordHash è§£ç ï¼‰
2. âœ… **é”™è¯¯å¤„ç†**ï¼šå·²å®ç°ï¼ˆè®°å½•è­¦å‘Šæ—¥å¿—å¹¶è¿”å›é”™è¯¯ï¼‰

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… è§£ç é€»è¾‘ä¸€è‡´
- âœ… é”™è¯¯å¤„ç†ä¸€è‡´

---

#### 1.3 Tenant ID è‡ªåŠ¨è§£æï¼ˆ128-299è¡Œï¼‰

**æ—§ Handler é€»è¾‘**ï¼ˆauth_handlers.go:128-299ï¼‰ï¼š
1. âœ… **è§¦å‘æ¡ä»¶**ï¼šå¦‚æœ `tenant_id` ä¸ºç©ºä¸”æ•°æ®åº“å¯ç”¨
2. âœ… **æŸ¥è¯¢é€»è¾‘ï¼ˆæ ¹æ® userTypeï¼‰**ï¼š
   - **resident**: å…ˆæŸ¥ `resident_contacts`ï¼Œå†æŸ¥ `residents`
   - **staff**: æŸ¥ `users` è¡¨
3. âœ… **ç»“æœå¤„ç†**ï¼š
   - 0 ä¸ªåŒ¹é…ï¼šè¿”å› "invalid credentials"
   - 1 ä¸ªåŒ¹é…ï¼šè‡ªåŠ¨è®¾ç½® `tenant_id`
   - >1 ä¸ªåŒ¹é…ï¼šè¿”å› "Multiple institutions found, please select one"

**æ–° Service é€»è¾‘**ï¼ˆauth_service.go:110-145ï¼‰ï¼š
1. âœ… **è§¦å‘æ¡ä»¶**ï¼šå·²å®ç°ï¼ˆå¦‚æœ tenantID ä¸ºç©ºï¼‰
2. âœ… **æŸ¥è¯¢é€»è¾‘**ï¼šå·²å®ç°ï¼ˆé€šè¿‡ Repository çš„ SearchTenantsForResidentLogin å’Œ SearchTenantsForUserLoginï¼‰
3. âœ… **ç»“æœå¤„ç†**ï¼šå·²å®ç°ï¼ˆ0/1/>1 åŒ¹é…å¤„ç†ï¼‰

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… æŸ¥è¯¢é€»è¾‘ä¸€è‡´
- âœ… ç»“æœå¤„ç†ä¸€è‡´

---

#### 1.4 ç”¨æˆ·éªŒè¯å’Œç™»å½•ï¼ˆ301-536è¡Œï¼‰

**æ—§ Handler é€»è¾‘**ï¼ˆauth_handlers.go:301-536ï¼‰ï¼š
1. âœ… **tenant_id éªŒè¯**ï¼šå¦‚æœä¸ºç©ºï¼Œè¿”å› "tenant_id is required"
2. âœ… **æ ¹æ® userType æŸ¥è¯¢ç”¨æˆ·**ï¼š
   - **resident**: å…ˆæŸ¥ `resident_contacts`ï¼Œå†æŸ¥ `residents`
   - **staff**: æŸ¥ `users` è¡¨
3. âœ… **çŠ¶æ€éªŒè¯**ï¼š
   - resident_contact: æ£€æŸ¥ `is_enabled = true`
   - resident: æ£€æŸ¥ `status = 'active'`
   - staff: æ£€æŸ¥ `status = 'active'`
4. âœ… **ç”¨æˆ·ä¿¡æ¯å¤„ç†**ï¼š
   - resident_contact: `userAccount = contact_id`, `nickName = first + last` æˆ– `role`
   - resident: `userAccount = resident_account`, `nickName = nickname`
   - staff: `userAccount = user_account`, `nickName = nickname`

**æ–° Service é€»è¾‘**ï¼ˆauth_service.go:147-250ï¼‰ï¼š
1. âœ… **tenant_id éªŒè¯**ï¼šå·²å®ç°
2. âœ… **æ ¹æ® userType æŸ¥è¯¢ç”¨æˆ·**ï¼šå·²å®ç°ï¼ˆé€šè¿‡ Repository çš„ GetResidentContactForLogin, GetResidentForLogin, GetUserForLoginï¼‰
3. âœ… **çŠ¶æ€éªŒè¯**ï¼šå·²å®ç°ï¼ˆæ£€æŸ¥ is_enabled å’Œ statusï¼‰
4. âœ… **ç”¨æˆ·ä¿¡æ¯å¤„ç†**ï¼šå·²å®ç°ï¼ˆuserAccount å’Œ nickName å¤„ç†é€»è¾‘ä¸€è‡´ï¼‰

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… æŸ¥è¯¢é€»è¾‘ä¸€è‡´
- âœ… çŠ¶æ€éªŒè¯ä¸€è‡´
- âœ… ç”¨æˆ·ä¿¡æ¯å¤„ç†ä¸€è‡´

---

#### 1.5 ç™»å½•åå¤„ç†ï¼ˆ549-599è¡Œï¼‰

**æ—§ Handler é€»è¾‘**ï¼ˆauth_handlers.go:549-599ï¼‰ï¼š
1. âœ… **nickName é»˜è®¤å€¼**ï¼šå¦‚æœä¸ºç©ºï¼Œä½¿ç”¨ `role` æˆ– `userAccount`
2. âœ… **æ›´æ–° last_login_at**ï¼šä»…å¯¹ staff ç”¨æˆ·æ›´æ–°
3. âœ… **æ—¥å¿—è®°å½•**ï¼šè®°å½•æˆåŠŸç™»å½•æ—¥å¿—
4. âœ… **å“åº”æ„å»º**ï¼šæ„å»ºå®Œæ•´çš„ç™»å½•å“åº”

**æ–° Service é€»è¾‘**ï¼ˆauth_service.go:252-290ï¼‰ï¼š
1. âœ… **nickName é»˜è®¤å€¼**ï¼šå·²å®ç°
2. âœ… **æ›´æ–° last_login_at**ï¼šå·²å®ç°ï¼ˆé€šè¿‡ Repository çš„ UpdateUserLastLoginï¼‰
3. âœ… **æ—¥å¿—è®°å½•**ï¼šå·²å®ç°
4. âœ… **å“åº”æ„å»º**ï¼šå·²å®ç°

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… æ‰€æœ‰ä¸šåŠ¡é€»è¾‘ç‚¹éƒ½å·²è¦†ç›–
- âœ… é€»è¾‘ä¸€è‡´

---

### 2. GET /auth/api/v1/institutions/search å¯¹æ¯”

#### 2.1 å‚æ•°è§£æï¼ˆ608-616è¡Œï¼‰

**æ—§ Handler é€»è¾‘**ï¼ˆauth_handlers.go:608-616ï¼‰ï¼š
1. âœ… **å‚æ•°åˆ—è¡¨**ï¼š
   - `accountHash` (string, å¿…å¡«) - ä» Query å‚æ•°è·å–
   - `passwordHash` (string, å¿…å¡«) - ä» Query å‚æ•°è·å–
   - `userType` (string, å¯é€‰ï¼Œé»˜è®¤ä¸º "staff") - ä» Query å‚æ•°è·å–

2. âœ… **å‚æ•°è§„èŒƒåŒ–**ï¼š
   - `userType` è½¬æ¢ä¸ºå°å†™å¹¶ trim
   - å¦‚æœä¸ºç©ºï¼Œé»˜è®¤ä¸º "staff"
   - `accountHash` å’Œ `passwordHash` éƒ½ trim

**æ–° Service é€»è¾‘**ï¼ˆauth_service.go:295-310ï¼‰ï¼š
1. âœ… **å‚æ•°éªŒè¯**ï¼šå·²å®ç°ï¼ˆaccountHash å’Œ passwordHash å¿…å¡«ï¼‰
2. âœ… **å‚æ•°è§„èŒƒåŒ–**ï¼šå·²å®ç°ï¼ˆuserType è§„èŒƒåŒ–ï¼ŒaccountHash å’Œ passwordHash trimï¼‰

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… å‚æ•°éªŒè¯é€»è¾‘ä¸€è‡´
- âœ… å‚æ•°è§„èŒƒåŒ–é€»è¾‘ä¸€è‡´

---

#### 2.2 Hash è§£ç å’ŒéªŒè¯ï¼ˆ620-630è¡Œï¼‰

**æ—§ Handler é€»è¾‘**ï¼ˆauth_handlers.go:620-630ï¼‰ï¼š
1. âœ… **Hex è§£ç **ï¼š
   - `accountHash` ä» hex å­—ç¬¦ä¸²è§£ç ä¸º `[]byte`
   - `passwordHash` ä» hex å­—ç¬¦ä¸²è§£ç ä¸º `[]byte`
   - å¦‚æœè§£ç å¤±è´¥æˆ–é•¿åº¦ä¸º 0ï¼Œè¿”å›ç©ºæ•°ç»„ `[]`

**æ–° Service é€»è¾‘**ï¼ˆauth_service.go:312-325ï¼‰ï¼š
1. âœ… **Hex è§£ç **ï¼šå·²å®ç°ï¼ˆaccountHash å’Œ passwordHash è§£ç ï¼‰
2. âœ… **é”™è¯¯å¤„ç†**ï¼šå·²å®ç°ï¼ˆå¦‚æœè§£ç å¤±è´¥ï¼Œè¿”å›ç©ºæ•°ç»„ï¼‰

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… è§£ç é€»è¾‘ä¸€è‡´
- âœ… é”™è¯¯å¤„ç†ä¸€è‡´

---

#### 2.3 æŸ¥è¯¢åŒ¹é…çš„æœºæ„ï¼ˆ631-813è¡Œï¼‰

**æ—§ Handler é€»è¾‘**ï¼ˆauth_handlers.go:631-813ï¼‰ï¼š
1. âœ… **æŸ¥è¯¢é€»è¾‘ï¼ˆæ ¹æ® userTypeï¼‰**ï¼š
   - **resident**: å…ˆæŸ¥ `resident_contacts`ï¼Œå†æŸ¥ `residents`
   - **staff**: æŸ¥ `users` è¡¨
2. âœ… **ç»“æœå¤„ç†**ï¼šæŸ¥è¯¢è¿”å› `tenant_id` å’Œ `account_type`
3. âœ… **æœºæ„ä¿¡æ¯è¡¥å……**ï¼šæŸ¥è¯¢æœºæ„è¯¦ç»†ä¿¡æ¯ï¼ˆtenant_name, domainï¼‰
4. âœ… **å®‰å…¨æœºåˆ¶**ï¼šåªè¿”å›åŒ¹é…è´¦å·å’Œå¯†ç çš„æœºæ„

**æ–° Service é€»è¾‘**ï¼ˆauth_service.go:327-380ï¼‰ï¼š
1. âœ… **æŸ¥è¯¢é€»è¾‘**ï¼šå·²å®ç°ï¼ˆé€šè¿‡ Repository çš„ SearchTenantsForResidentLogin å’Œ SearchTenantsForUserLoginï¼‰
2. âœ… **ç»“æœå¤„ç†**ï¼šå·²å®ç°ï¼ˆè¿”å› tenant_id å’Œ account_typeï¼‰
3. âœ… **æœºæ„ä¿¡æ¯è¡¥å……**ï¼šå·²å®ç°ï¼ˆé€šè¿‡ TenantsRepository çš„ GetTenantï¼‰
4. âœ… **å®‰å…¨æœºåˆ¶**ï¼šå·²å®ç°ï¼ˆåªè¿”å›åŒ¹é…çš„æœºæ„ï¼‰

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… æŸ¥è¯¢é€»è¾‘ä¸€è‡´
- âœ… ç»“æœå¤„ç†ä¸€è‡´
- âœ… æœºæ„ä¿¡æ¯è¡¥å……ä¸€è‡´
- âœ… å®‰å…¨æœºåˆ¶ä¸€è‡´

---

### 3. POST /auth/api/v1/forgot-password/send-code å¯¹æ¯”

**æ—§ Handler é€»è¾‘**ï¼ˆauth_handlers.go:863-869ï¼‰ï¼š
- âš ï¸ **å¾…å®ç°**ï¼šç›®å‰åªè¿”å› "database not available"

**æ–° Service é€»è¾‘**ï¼ˆauth_service.go:383-395ï¼‰ï¼š
- âš ï¸ **å¾…å®ç°**ï¼šç›®å‰åªè¿”å› "database not available"

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… é€»è¾‘ä¸€è‡´ï¼ˆéƒ½å¾…å®ç°ï¼‰

---

### 4. POST /auth/api/v1/forgot-password/verify-code å¯¹æ¯”

**æ—§ Handler é€»è¾‘**ï¼ˆauth_handlers.go:870-876ï¼‰ï¼š
- âš ï¸ **å¾…å®ç°**ï¼šç›®å‰åªè¿”å› "database not available"

**æ–° Service é€»è¾‘**ï¼ˆauth_service.go:397-409ï¼‰ï¼š
- âš ï¸ **å¾…å®ç°**ï¼šç›®å‰åªè¿”å› "database not available"

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… é€»è¾‘ä¸€è‡´ï¼ˆéƒ½å¾…å®ç°ï¼‰

---

### 5. POST /auth/api/v1/forgot-password/reset å¯¹æ¯”

**æ—§ Handler é€»è¾‘**ï¼ˆauth_handlers.go:877-883ï¼‰ï¼š
- âš ï¸ **å¾…å®ç°**ï¼šç›®å‰åªè¿”å› "database not available"

**æ–° Service é€»è¾‘**ï¼ˆauth_service.go:411-423ï¼‰ï¼š
- âš ï¸ **å¾…å®ç°**ï¼šç›®å‰åªè¿”å› "database not available"

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… é€»è¾‘ä¸€è‡´ï¼ˆéƒ½å¾…å®ç°ï¼‰

---

## ğŸ“Š å…³é”®å·®å¼‚æ€»ç»“

| åŠŸèƒ½ç‚¹ | æ—§ Handler | æ–° Service | çŠ¶æ€ |
|--------|-----------|-----------|------|
| å‚æ•°è§£æ | âœ… åœ¨ Handler å±‚ | âœ… åœ¨ Handler å±‚ | âœ… ä¸€è‡´ |
| Hash è§£ç  | âœ… åœ¨ Handler å±‚ | âœ… åœ¨ Service å±‚ | âš ï¸ ä½ç½®ä¸åŒï¼ˆç¬¦åˆèŒè´£è¾¹ç•Œï¼‰ |
| Tenant ID è‡ªåŠ¨è§£æ | âœ… åœ¨ Handler å±‚ | âœ… åœ¨ Service å±‚ | âœ… ä¸€è‡´ |
| ç”¨æˆ·éªŒè¯ | âœ… ç›´æ¥ SQL | âœ… é€šè¿‡ Repository | âœ… ä¸€è‡´ |
| çŠ¶æ€éªŒè¯ | âœ… åœ¨ SQL ä¸­ | âœ… åœ¨ Repository ä¸­ | âœ… ä¸€è‡´ |
| ç™»å½•åå¤„ç† | âœ… åœ¨ Handler å±‚ | âœ… åœ¨ Service å±‚ | âœ… ä¸€è‡´ |
| æ—¥å¿—è®°å½• | âœ… åœ¨ Handler å±‚ | âœ… åœ¨ Service å±‚ | âœ… ä¸€è‡´ |
| å“åº”æ„å»º | âœ… åœ¨ Handler å±‚ | âœ… åœ¨ Service å±‚ | âœ… ä¸€è‡´ |

---

## âœ… éªŒè¯ç»“è®º

### ä¸šåŠ¡é€»è¾‘å®Œæ•´æ€§ï¼šâœ… **å®Œå…¨ä¸€è‡´**

1. âœ… **POST /auth/api/v1/login**ï¼šæ‰€æœ‰ä¸šåŠ¡é€»è¾‘ç‚¹éƒ½å·²è¦†ç›–
2. âœ… **GET /auth/api/v1/institutions/search**ï¼šæ‰€æœ‰ä¸šåŠ¡é€»è¾‘ç‚¹éƒ½å·²è¦†ç›–
3. âš ï¸ **POST /auth/api/v1/forgot-password/send-code**ï¼šå¾…å®ç°
4. âš ï¸ **POST /auth/api/v1/forgot-password/verify-code**ï¼šå¾…å®ç°
5. âš ï¸ **POST /auth/api/v1/forgot-password/reset**ï¼šå¾…å®ç°

### èŒè´£è¾¹ç•Œï¼šâœ… **ç¬¦åˆè®¾è®¡åŸåˆ™**

- âœ… å‚æ•°è§£æåœ¨ Handler å±‚ï¼ˆç¬¦åˆèŒè´£è¾¹ç•Œï¼‰
- âœ… Hash è§£ç åœ¨ Service å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
- âœ… ç”¨æˆ·éªŒè¯åœ¨ Service å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
- âœ… æ—¥å¿—è®°å½•åœ¨ Service å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰

---

## ğŸ¯ æœ€ç»ˆç»“è®º

**âœ… æ–° Service ä¸æ—§ Handler çš„ä¸šåŠ¡é€»è¾‘å®Œå…¨ä¸€è‡´ï¼ˆé™¤å¯†ç é‡ç½®åŠŸèƒ½å¾…å®ç°ï¼‰ã€‚**

**âœ… å¯ä»¥å®‰å…¨æ›¿æ¢æ—§ Handlerï¼ˆå¯†ç é‡ç½®åŠŸèƒ½å¾…å®ç°ï¼‰**

