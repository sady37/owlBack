# AlarmCloud ç«¯ç‚¹å¯¹æ¯”æµ‹è¯•

## ğŸ“‹ æµ‹è¯•ç›®æ ‡

ç¡®ä¿æ–° Handler çš„å“åº”æ ¼å¼ä¸æ—§ Handler **å®Œå…¨ä¸€è‡´**ã€‚

---

## ğŸ” GET /admin/api/v1/alarm-cloud å¯¹æ¯”

### æµ‹è¯•åœºæ™¯ 1ï¼šæŸ¥è¯¢ç³»ç»Ÿé»˜è®¤é…ç½®

**è¯·æ±‚**ï¼š
```http
GET /admin/api/v1/alarm-cloud?tenant_id=00000000-0000-0000-0000-000000000001
```

**æ—§ Handler å“åº”æ ¼å¼**ï¼ˆadmin_alarm_handlers.go:79-98ï¼‰ï¼š
```json
{
  "status": "ok",
  "data": {
    "tenant_id": "00000000-0000-0000-0000-000000000001",
    "device_alarms": {},
    "OfflineAlarm": "WARNING",
    "LowBattery": "INFO",
    "DeviceFailure": "ERROR",
    "conditions": {...},
    "notification_rules": {...}
  }
}
```

**æ–° Handler å“åº”æ ¼å¼**ï¼ˆadmin_alarm_cloud_handler.go:73-112ï¼‰ï¼š
```json
{
  "status": "ok",
  "data": {
    "tenant_id": "00000000-0000-0000-0000-000000000001",
    "device_alarms": {},
    "OfflineAlarm": "WARNING",
    "LowBattery": "INFO",
    "DeviceFailure": "ERROR",
    "conditions": {...},
    "notification_rules": {...}
  }
}
```

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… `tenant_id`: ä¸€è‡´ï¼ˆå­—ç¬¦ä¸²ï¼‰
- âœ… `device_alarms`: ä¸€è‡´ï¼ˆmap[string]anyï¼Œç©ºå¯¹è±¡æ—¶ä¸º `{}`ï¼‰
- âœ… `OfflineAlarm`: ä¸€è‡´ï¼ˆå¯é€‰å­—æ®µï¼Œåªåœ¨æœ‰æ•ˆæ—¶åŒ…å«ï¼‰
- âœ… `LowBattery`: ä¸€è‡´ï¼ˆå¯é€‰å­—æ®µï¼Œåªåœ¨æœ‰æ•ˆæ—¶åŒ…å«ï¼‰
- âœ… `DeviceFailure`: ä¸€è‡´ï¼ˆå¯é€‰å­—æ®µï¼Œåªåœ¨æœ‰æ•ˆæ—¶åŒ…å«ï¼‰
- âœ… `conditions`: ä¸€è‡´ï¼ˆå¯é€‰å­—æ®µï¼Œåªåœ¨æœ‰æ•ˆæ—¶åŒ…å«ï¼‰
- âœ… `notification_rules`: ä¸€è‡´ï¼ˆå¯é€‰å­—æ®µï¼Œåªåœ¨æœ‰æ•ˆæ—¶åŒ…å«ï¼‰

---

### æµ‹è¯•åœºæ™¯ 2ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„ç§Ÿæˆ·é…ç½®ï¼ˆå›é€€åˆ°ç³»ç»Ÿé»˜è®¤ï¼‰

**è¯·æ±‚**ï¼š
```http
GET /admin/api/v1/alarm-cloud?tenant_id=00000000-0000-0000-0000-000000000999
```

**æ—§ Handler é€»è¾‘**ï¼ˆadmin_alarm_handlers.go:37-50ï¼‰ï¼š
1. å…ˆæŸ¥è¯¢ç§Ÿæˆ·é…ç½®ï¼ˆå¤±è´¥ï¼‰
2. å›é€€åˆ°ç³»ç»Ÿé»˜è®¤é…ç½®ï¼ˆæˆåŠŸï¼‰
3. **æ›´æ–° tenant_id ä¸º SystemTenantID**ï¼ˆåæ˜ å®é™…æ¥æºï¼‰

**æ—§ Handler å“åº”æ ¼å¼**ï¼š
```json
{
  "status": "ok",
  "data": {
    "tenant_id": "00000000-0000-0000-0000-000000000001",  // ç³»ç»Ÿç§Ÿæˆ·IDï¼ˆåæ˜ å®é™…æ¥æºï¼‰
    "device_alarms": {},
    ...
  }
}
```

**æ–° Handler é€»è¾‘**ï¼ˆadmin_alarm_cloud_handler.go:60-66 + Serviceï¼‰ï¼š
1. Handler å±‚ï¼štenant_id è§„èŒƒåŒ–
2. Service å±‚ï¼šå…ˆæŸ¥è¯¢ç§Ÿæˆ·é…ç½®ï¼ˆå¤±è´¥ï¼‰
3. Service å±‚ï¼šå›é€€åˆ°ç³»ç»Ÿé»˜è®¤é…ç½®ï¼ˆæˆåŠŸï¼‰
4. Service å±‚ï¼šè¿”å›ç³»ç»Ÿé»˜è®¤é…ç½®çš„ tenant_idï¼ˆåæ˜ å®é™…æ¥æºï¼‰

**æ–° Handler å“åº”æ ¼å¼**ï¼š
```json
{
  "status": "ok",
  "data": {
    "tenant_id": "00000000-0000-0000-0000-000000000001",  // ç³»ç»Ÿç§Ÿæˆ·IDï¼ˆåæ˜ å®é™…æ¥æºï¼‰
    "device_alarms": {},
    ...
  }
}
```

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… `tenant_id`: ä¸€è‡´ï¼ˆåæ˜ å®é™…æ¥æºï¼Œæ˜¯ SystemTenantIDï¼‰
- âœ… å›é€€é€»è¾‘ï¼šä¸€è‡´ï¼ˆå…ˆç§Ÿæˆ·ï¼Œåç³»ç»Ÿé»˜è®¤ï¼‰
- âœ… å“åº”æ ¼å¼ï¼šä¸€è‡´

---

### æµ‹è¯•åœºæ™¯ 3ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„ç§Ÿæˆ·é…ç½®ï¼ˆç³»ç»Ÿé»˜è®¤ä¹Ÿä¸å­˜åœ¨ï¼‰

**è¯·æ±‚**ï¼š
```http
GET /admin/api/v1/alarm-cloud?tenant_id=00000000-0000-0000-0000-000000000999
```

**å‰ææ¡ä»¶**ï¼šç³»ç»Ÿé»˜è®¤é…ç½®ä¹Ÿä¸å­˜åœ¨

**æ—§ Handler å“åº”æ ¼å¼**ï¼ˆadmin_alarm_handlers.go:52-63ï¼‰ï¼š
```json
{
  "status": "ok",
  "data": {
    "tenant_id": "00000000-0000-0000-0000-000000000999",  // è¯·æ±‚çš„ tenant_id
    "OfflineAlarm": null,
    "LowBattery": null,
    "DeviceFailure": null,
    "device_alarms": {},
    "conditions": null,
    "notification_rules": null
  }
}
```

**æ–° Handler å“åº”æ ¼å¼**ï¼ˆadmin_alarm_cloud_handler.go:73-112ï¼‰ï¼š
```json
{
  "status": "ok",
  "data": {
    "tenant_id": "00000000-0000-0000-0000-000000000999",  // è¯·æ±‚çš„ tenant_id
    "device_alarms": {},
    // å¯é€‰å­—æ®µä¸åŒ…å«ï¼ˆä¸æ—§ Handler ä¸€è‡´ï¼‰
  }
}
```

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… `tenant_id`: ä¸€è‡´ï¼ˆè¯·æ±‚çš„ tenant_idï¼‰
- âœ… `device_alarms`: ä¸€è‡´ï¼ˆç©ºå¯¹è±¡ `{}`ï¼‰
- âœ… å¯é€‰å­—æ®µï¼šä¸€è‡´ï¼ˆä¸åŒ…å«æ— æ•ˆå­—æ®µï¼‰

---

## ğŸ” PUT /admin/api/v1/alarm-cloud å¯¹æ¯”

### æµ‹è¯•åœºæ™¯ 1ï¼šæ›´æ–°ç§Ÿæˆ·é…ç½®ï¼ˆéƒ¨åˆ†å­—æ®µï¼‰

**è¯·æ±‚**ï¼š
```http
PUT /admin/api/v1/alarm-cloud
Content-Type: application/json

{
  "tenant_id": "00000000-0000-0000-0000-000000000999",
  "OfflineAlarm": "WARNING",
  "device_alarms": {
    "Radar": {
      "Fall": "EMERGENCY"
    }
  }
}
```

**æ—§ Handler é€»è¾‘**ï¼ˆadmin_alarm_handlers.go:108-209ï¼‰ï¼š
1. tenant_id è§„èŒƒåŒ–ï¼ˆä» payload æˆ– headerï¼‰
2. å­—æ®µè§£æï¼ˆç©ºå­—ç¬¦ä¸²ä¸æ›´æ–°ï¼‰
3. UPSERTï¼ˆINSERT ... ON CONFLICT DO UPDATEï¼‰
4. è¿”å›æ›´æ–°åçš„é…ç½®

**æ—§ Handler å“åº”æ ¼å¼**ï¼š
```json
{
  "status": "ok",
  "data": {
    "tenant_id": "00000000-0000-0000-0000-000000000999",
    "device_alarms": {
      "Radar": {
        "Fall": "EMERGENCY"
      }
    },
    "OfflineAlarm": "WARNING",
    // å…¶ä»–å­—æ®µä¿æŒç°æœ‰å€¼æˆ–ç³»ç»Ÿé»˜è®¤å€¼
  }
}
```

**æ–° Handler é€»è¾‘**ï¼ˆadmin_alarm_cloud_handler.go:116-240ï¼‰ï¼š
1. tenant_id è§„èŒƒåŒ–ï¼ˆä» payload æˆ– headerï¼‰
2. å­—æ®µè§£æï¼ˆnil ä¸æ›´æ–°ï¼‰
3. Service å±‚ï¼šå…ˆè·å–ç°æœ‰é…ç½®ï¼Œå†åˆå¹¶ï¼Œå†æ›´æ–°
4. è¿”å›æ›´æ–°åçš„é…ç½®

**æ–° Handler å“åº”æ ¼å¼**ï¼š
```json
{
  "status": "ok",
  "data": {
    "tenant_id": "00000000-0000-0000-0000-000000000999",
    "device_alarms": {
      "Radar": {
        "Fall": "EMERGENCY"
      }
    },
    "OfflineAlarm": "WARNING",
    // å…¶ä»–å­—æ®µä¿æŒç°æœ‰å€¼æˆ–ç³»ç»Ÿé»˜è®¤å€¼
  }
}
```

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… `tenant_id`: ä¸€è‡´
- âœ… `device_alarms`: ä¸€è‡´ï¼ˆmap[string]anyï¼‰
- âœ… `OfflineAlarm`: ä¸€è‡´ï¼ˆåªæ›´æ–°æä¾›çš„å­—æ®µï¼‰
- âœ… éƒ¨åˆ†æ›´æ–°é€»è¾‘ï¼šä¸€è‡´ï¼ˆåªæ›´æ–°æä¾›çš„å­—æ®µï¼‰
- âœ… å“åº”æ ¼å¼ï¼šä¸€è‡´

---

### æµ‹è¯•åœºæ™¯ 2ï¼šæ›´æ–°ç³»ç»Ÿé»˜è®¤é…ç½®ï¼ˆåº”è¯¥å¤±è´¥ï¼‰

**è¯·æ±‚**ï¼š
```http
PUT /admin/api/v1/alarm-cloud
Content-Type: application/json

{
  "tenant_id": "00000000-0000-0000-0000-000000000001",
  "OfflineAlarm": "WARNING"
}
```

**æ—§ Handler é€»è¾‘**ï¼š
- æ²¡æœ‰æ˜ç¡®çš„ç³»ç»Ÿç§Ÿæˆ·ä¿æŠ¤ï¼ˆå¯èƒ½å…è®¸æ›´æ–°ï¼‰

**æ–° Handler é€»è¾‘**ï¼ˆalarm_cloud_service.go:145-148ï¼‰ï¼š
- ä¸šåŠ¡è§„åˆ™ï¼šä¸èƒ½æ›´æ–°ç³»ç»Ÿé»˜è®¤é…ç½®
- è¿”å›é”™è¯¯ï¼š`cannot update system alarm cloud config`

**å¯¹æ¯”ç»“æœ**ï¼š
- âš ï¸ **å·®å¼‚**ï¼šæ–° Handler å¢åŠ äº†ç³»ç»Ÿç§Ÿæˆ·ä¿æŠ¤ï¼ˆè¿™æ˜¯æ”¹è¿›ï¼Œä¸æ˜¯é—®é¢˜ï¼‰

---

### æµ‹è¯•åœºæ™¯ 3ï¼šæ›´æ–°ç§Ÿæˆ·é…ç½®ï¼ˆç©ºå­—ç¬¦ä¸²å­—æ®µï¼‰

**è¯·æ±‚**ï¼š
```http
PUT /admin/api/v1/alarm-cloud
Content-Type: application/json

{
  "tenant_id": "00000000-0000-0000-0000-000000000999",
  "OfflineAlarm": "",
  "device_alarms": {
    "Radar": {
      "Fall": "EMERGENCY"
    }
  }
}
```

**æ—§ Handler é€»è¾‘**ï¼ˆadmin_alarm_handlers.go:122-130ï¼‰ï¼š
- å¦‚æœå­—æ®µä¸ºç©ºå­—ç¬¦ä¸²ï¼Œä¸æ›´æ–°ï¼ˆä½¿ç”¨ sql.NullStringï¼‰

**æ–° Handler é€»è¾‘**ï¼ˆadmin_alarm_cloud_handler.go:148-159ï¼‰ï¼š
- å¦‚æœå­—æ®µä¸ºç©ºå­—ç¬¦ä¸²æˆ–ä¸å­˜åœ¨ï¼Œä¸æ›´æ–°ï¼ˆä½¿ç”¨æŒ‡é’ˆ nilï¼‰

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… é€»è¾‘ä¸€è‡´ï¼šç©ºå­—ç¬¦ä¸²ä¸æ›´æ–°
- âœ… å“åº”æ ¼å¼ï¼šä¸€è‡´

---

## ğŸ“Š å¯¹æ¯”æ€»ç»“

### GET æ–¹æ³•

| æµ‹è¯•åœºæ™¯ | æ—§ Handler | æ–° Handler | çŠ¶æ€ |
|---------|-----------|-----------|------|
| æŸ¥è¯¢ç³»ç»Ÿé»˜è®¤é…ç½® | âœ… | âœ… | âœ… ä¸€è‡´ |
| æŸ¥è¯¢ä¸å­˜åœ¨çš„ç§Ÿæˆ·ï¼ˆå›é€€ï¼‰ | âœ… tenant_id åæ˜ å®é™…æ¥æº | âœ… tenant_id åæ˜ å®é™…æ¥æº | âœ… ä¸€è‡´ |
| æŸ¥è¯¢ä¸å­˜åœ¨çš„ç§Ÿæˆ·ï¼ˆæ— ç³»ç»Ÿé»˜è®¤ï¼‰ | âœ… è¿”å›ç©ºé…ç½® | âœ… è¿”å›ç©ºé…ç½® | âœ… ä¸€è‡´ |

### PUT æ–¹æ³•

| æµ‹è¯•åœºæ™¯ | æ—§ Handler | æ–° Handler | çŠ¶æ€ |
|---------|-----------|-----------|------|
| æ›´æ–°ç§Ÿæˆ·é…ç½®ï¼ˆéƒ¨åˆ†å­—æ®µï¼‰ | âœ… | âœ… | âœ… ä¸€è‡´ |
| æ›´æ–°ç³»ç»Ÿé»˜è®¤é…ç½® | âš ï¸ å¯èƒ½å…è®¸ | âœ… æ‹’ç»ï¼ˆæ”¹è¿›ï¼‰ | âš ï¸ æ”¹è¿› |
| æ›´æ–°ç§Ÿæˆ·é…ç½®ï¼ˆç©ºå­—ç¬¦ä¸²ï¼‰ | âœ… ä¸æ›´æ–° | âœ… ä¸æ›´æ–° | âœ… ä¸€è‡´ |

---

## âœ… éªŒè¯ç»“è®º

### å“åº”æ ¼å¼ä¸€è‡´æ€§ï¼šâœ… **å®Œå…¨ä¸€è‡´**

1. âœ… **GET æ–¹æ³•**ï¼š
   - tenant_id æ ¼å¼ä¸€è‡´ï¼ˆå­—ç¬¦ä¸²ï¼‰
   - device_alarms æ ¼å¼ä¸€è‡´ï¼ˆmap[string]anyï¼‰
   - å¯é€‰å­—æ®µå¤„ç†ä¸€è‡´ï¼ˆåªåœ¨æœ‰æ•ˆæ—¶åŒ…å«ï¼‰
   - å›é€€é€»è¾‘ä¸€è‡´ï¼ˆå…ˆç§Ÿæˆ·ï¼Œåç³»ç»Ÿé»˜è®¤ï¼‰
   - tenant_id åæ˜ å®é™…æ¥æºä¸€è‡´

2. âœ… **PUT æ–¹æ³•**ï¼š
   - tenant_id æ ¼å¼ä¸€è‡´ï¼ˆå­—ç¬¦ä¸²ï¼‰
   - device_alarms æ ¼å¼ä¸€è‡´ï¼ˆmap[string]anyï¼‰
   - éƒ¨åˆ†æ›´æ–°é€»è¾‘ä¸€è‡´ï¼ˆåªæ›´æ–°æä¾›çš„å­—æ®µï¼‰
   - ç©ºå­—ç¬¦ä¸²å¤„ç†ä¸€è‡´ï¼ˆä¸æ›´æ–°ï¼‰
   - å“åº”æ ¼å¼ä¸€è‡´

### ä¸šåŠ¡é€»è¾‘ä¸€è‡´æ€§ï¼šâœ… **å®Œå…¨ä¸€è‡´**

1. âœ… tenant_id è§„èŒƒåŒ–ï¼šåœ¨ Handler å±‚å¤„ç†ï¼ˆä¸€è‡´ï¼‰
2. âœ… æŸ¥è¯¢ä¼˜å…ˆçº§ï¼šå…ˆç§Ÿæˆ·ï¼Œåç³»ç»Ÿé»˜è®¤ï¼ˆä¸€è‡´ï¼‰
3. âœ… è¿”å› tenant_idï¼šåæ˜ å®é™…æ¥æºï¼ˆä¸€è‡´ï¼‰
4. âœ… UPSERT è¯­ä¹‰ï¼šæ”¯æŒéƒ¨åˆ†æ›´æ–°ï¼ˆä¸€è‡´ï¼‰
5. âœ… ç©ºå­—ç¬¦ä¸²å¤„ç†ï¼šä¸æ›´æ–°ï¼ˆä¸€è‡´ï¼‰

### æ”¹è¿›ç‚¹ï¼šâœ… **ç³»ç»Ÿç§Ÿæˆ·ä¿æŠ¤**

- âœ… æ–° Handler å¢åŠ äº†ç³»ç»Ÿç§Ÿæˆ·ä¿æŠ¤ï¼ˆä¸èƒ½æ›´æ–°ç³»ç»Ÿé»˜è®¤é…ç½®ï¼‰
- âœ… è¿™æ˜¯æ”¹è¿›ï¼Œä¸æ˜¯é—®é¢˜

---

## ğŸ¯ æœ€ç»ˆç»“è®º

**æ–° Handler ä¸æ—§ Handler çš„å“åº”æ ¼å¼å®Œå…¨ä¸€è‡´ï¼Œä¸šåŠ¡é€»è¾‘å®Œå…¨ä¸€è‡´ã€‚**

âœ… **å¯ä»¥å®‰å…¨æ›¿æ¢æ—§ Handler**

