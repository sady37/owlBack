# Sleepace Report Service å’Œ Handler æœ€ç»ˆæ£€æŸ¥æ¸…å•

## âœ… å·²å®Œæˆ

1. **æ ¸å¿ƒåŠŸèƒ½**
   - âœ… æŸ¥è¯¢æŠ¥å‘Šåˆ—è¡¨
   - âœ… æŸ¥è¯¢æŠ¥å‘Šè¯¦æƒ…
   - âœ… æŸ¥è¯¢æœ‰æ•ˆæ—¥æœŸåˆ—è¡¨
   - âœ… æ‰‹åŠ¨è§¦å‘ä¸‹è½½æŠ¥å‘Š

2. **åŸºç¡€æ¶æ„**
   - âœ… Repository å±‚ï¼ˆPostgreSQLï¼‰
   - âœ… Service å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
   - âœ… Handler å±‚ï¼ˆHTTP å¤„ç†ï¼‰
   - âœ… è·¯ç”±æ³¨å†Œ

3. **ä»£ç ä¿®å¤**
   - âœ… ä¿®å¤é‡å¤çš„ `parseIntQuery` å‡½æ•°å®šä¹‰
   - âœ… æ·»åŠ ç¼ºå°‘çš„ importï¼ˆ`context`, `database/sql`, `fmt`ï¼‰

---

## â³ å¾…å¤„ç†äº‹é¡¹

### 1. æƒé™æ£€æŸ¥ï¼ˆéœ€è¦ç¡®è®¤ï¼‰â“

**ç°çŠ¶åˆ†æ**ï¼š

**æœ‰æƒé™æ£€æŸ¥çš„ Handler**ï¼š
- âœ… `ResidentHandler` - æœ‰æƒé™æ£€æŸ¥ï¼ˆä½¿ç”¨ `GetResourcePermission`ï¼‰
- âœ… `AlarmEventService` - æœ‰æƒé™æ£€æŸ¥ï¼ˆ`checkHandlePermission`ï¼‰

**æ²¡æœ‰æƒé™æ£€æŸ¥çš„ Handler**ï¼š
- âŒ `DeviceHandler` - **æ²¡æœ‰æƒé™æ£€æŸ¥**
- âŒ `DeviceMonitorSettingsHandler` - **æ²¡æœ‰æƒé™æ£€æŸ¥**
- âŒ `SleepaceReportHandler` - **æ²¡æœ‰æƒé™æ£€æŸ¥**

**ç»“è®º**ï¼š
- Sleepace Report æ˜¯è®¾å¤‡ç›¸å…³çš„åŠŸèƒ½
- `DeviceHandler` å’Œ `DeviceMonitorSettingsHandler` éƒ½æ²¡æœ‰æƒé™æ£€æŸ¥
- **å»ºè®®**ï¼šSleepace Report Handler ä¹Ÿå¯ä»¥ä¸æ·»åŠ æƒé™æ£€æŸ¥ï¼ˆä¿æŒä¸€è‡´æ€§ï¼‰

**å¦‚æœå†³å®šæ·»åŠ æƒé™æ£€æŸ¥**ï¼š
- å‚è€ƒ `ResidentHandler` çš„å®ç°
- ä½¿ç”¨ `GetResourcePermission` è·å–æƒé™é…ç½®
- ä¼ é€’ç»™ Service å±‚å¤„ç†ï¼ˆå¦‚æœéœ€è¦è¿‡æ»¤ï¼‰

---

### 2. å•å…ƒæµ‹è¯•ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

**é—®é¢˜**ï¼šæ²¡æœ‰å•å…ƒæµ‹è¯•

**éœ€è¦æ·»åŠ çš„æµ‹è¯•**ï¼š

#### 2.1 Service å±‚æµ‹è¯•

**æ–‡ä»¶**ï¼š`internal/service/sleepace_report_service_test.go`ï¼ˆæ–°å»ºï¼‰

**æµ‹è¯•ç”¨ä¾‹**ï¼š
- âœ… `TestGetSleepaceReports` - æµ‹è¯•è·å–æŠ¥å‘Šåˆ—è¡¨
- âœ… `TestGetSleepaceReportDetail` - æµ‹è¯•è·å–æŠ¥å‘Šè¯¦æƒ…
- âœ… `TestGetSleepaceReportDates` - æµ‹è¯•è·å–æœ‰æ•ˆæ—¥æœŸåˆ—è¡¨
- âœ… `TestDownloadReport` - æµ‹è¯•ä¸‹è½½æŠ¥å‘Šï¼ˆéœ€è¦ mock Sleepace å®¢æˆ·ç«¯ï¼‰
- âœ… `TestValidateDevice` - æµ‹è¯•è®¾å¤‡éªŒè¯

**å‚è€ƒ**ï¼š
- `internal/service/resident_service_test.go`
- `internal/service/user_service_integration_test.go`

#### 2.2 Handler å±‚æµ‹è¯•

**æ–‡ä»¶**ï¼š`internal/http/sleepace_report_handler_test.go`ï¼ˆæ–°å»ºï¼‰

**æµ‹è¯•ç”¨ä¾‹**ï¼š
- âœ… æµ‹è¯•è·¯å¾„è§£æ
- âœ… æµ‹è¯•æŸ¥è¯¢å‚æ•°è§£æ
- âœ… æµ‹è¯•é”™è¯¯å¤„ç†

**å‚è€ƒ**ï¼š
- `internal/http/auth_handler_test.go`

---

### 3. é”™è¯¯å¤„ç†ä¼˜åŒ–ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

**å½“å‰çŠ¶æ€**ï¼š
- âœ… åŸºæœ¬çš„é”™è¯¯å¤„ç†ï¼ˆè¿”å›é”™è¯¯æ¶ˆæ¯ï¼‰
- âš ï¸ é”™è¯¯åˆ†ç±»å¯ä»¥æ›´ç»†è‡´

**å»ºè®®æ”¹è¿›**ï¼š
```go
// æ›´ç»†åŒ–çš„é”™è¯¯å¤„ç†
if err != nil {
    h.logger.Error("GetSleepaceReports failed",
        zap.String("tenant_id", tenantID),
        zap.String("device_id", deviceID),
        zap.Error(err),
    )
    
    // æ ¹æ®é”™è¯¯ç±»å‹è¿”å›ä¸åŒçš„é”™è¯¯æ¶ˆæ¯
    if strings.Contains(err.Error(), "not found") {
        writeJSON(w, http.StatusOK, Fail("device not found"))
    } else if strings.Contains(err.Error(), "access denied") {
        writeJSON(w, http.StatusOK, Fail("access denied"))
    } else {
        writeJSON(w, http.StatusOK, Fail(err.Error()))
    }
    return
}
```

---

### 4. æ—¥å¿—ä¼˜åŒ–ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

**å»ºè®®æ”¹è¿›**ï¼š
```go
// æ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—
h.logger.Info("GetSleepaceReports",
    zap.String("tenant_id", tenantID),
    zap.String("device_id", deviceID),
    zap.Int("start_date", startDate),
    zap.Int("end_date", endDate),
    zap.Int("page", page),
    zap.Int("size", size),
)
```

---

### 5. æ–‡æ¡£å®Œå–„ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

**éœ€è¦æ·»åŠ **ï¼š
- âœ… API ç«¯ç‚¹æ–‡æ¡£
- âœ… è¯·æ±‚å‚æ•°è¯´æ˜
- âœ… å“åº”æ ¼å¼è¯´æ˜
- âœ… é”™è¯¯ç è¯´æ˜

---

## ğŸ¯ ä¼˜å…ˆçº§æ’åº

### é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»å¤„ç†ï¼‰

1. **ä»£ç é—®é¢˜ä¿®å¤** âœ…
   - âœ… é‡å¤çš„å‡½æ•°å®šä¹‰ï¼ˆå·²ä¿®å¤ï¼‰
   - âœ… ç¼ºå°‘ importï¼ˆå·²ä¿®å¤ï¼‰

### ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®å¤„ç†ï¼‰

2. **å•å…ƒæµ‹è¯•**
   - Service å±‚æµ‹è¯•
   - Handler å±‚æµ‹è¯•

3. **æƒé™æ£€æŸ¥**ï¼ˆéœ€è¦ç¡®è®¤ï¼‰
   - å‚è€ƒ `DeviceHandler`ï¼ˆæ²¡æœ‰æƒé™æ£€æŸ¥ï¼‰
   - å¦‚æœå†³å®šæ·»åŠ ï¼Œå‚è€ƒ `ResidentHandler`

### ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰

4. **é”™è¯¯å¤„ç†ä¼˜åŒ–**
5. **æ—¥å¿—ä¼˜åŒ–**
6. **æ–‡æ¡£å®Œå–„**

---

## ğŸ“ å®æ–½å»ºè®®

### ç¬¬ä¸€æ­¥ï¼šç¡®è®¤æƒé™æ£€æŸ¥éœ€æ±‚

**é—®é¢˜**ï¼šæ˜¯å¦éœ€è¦æƒé™æ£€æŸ¥ï¼Ÿ

**å‚è€ƒ**ï¼š
- `DeviceHandler` - æ²¡æœ‰æƒé™æ£€æŸ¥
- `DeviceMonitorSettingsHandler` - æ²¡æœ‰æƒé™æ£€æŸ¥
- `ResidentHandler` - æœ‰æƒé™æ£€æŸ¥ï¼ˆå› ä¸ºæ¶‰åŠæ•æ„Ÿæ•°æ®ï¼‰

**å»ºè®®**ï¼š
- å¦‚æœ Sleepace Report æ˜¯è®¾å¤‡ç›¸å…³çš„åŠŸèƒ½ï¼Œå¯ä»¥**ä¸æ·»åŠ æƒé™æ£€æŸ¥**ï¼ˆä¿æŒä¸ `DeviceHandler` ä¸€è‡´ï¼‰
- å¦‚æœ Sleepace Report æ¶‰åŠæ•æ„Ÿæ•°æ®ï¼Œå¯ä»¥**æ·»åŠ æƒé™æ£€æŸ¥**ï¼ˆå‚è€ƒ `ResidentHandler`ï¼‰

### ç¬¬äºŒæ­¥ï¼šæ·»åŠ å•å…ƒæµ‹è¯•ï¼ˆå¦‚æœæ—¶é—´å…è®¸ï¼‰

**æ–‡ä»¶**ï¼š
- `internal/service/sleepace_report_service_test.go`
- `internal/http/sleepace_report_handler_test.go`

---

## âœ… æ€»ç»“

**å½“å‰çŠ¶æ€**ï¼š
- âœ… æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆ
- âœ… åŸºç¡€æ¶æ„å®Œæ•´
- âœ… ä»£ç é—®é¢˜å·²ä¿®å¤
- â“ **æƒé™æ£€æŸ¥**ï¼ˆéœ€è¦ç¡®è®¤æ˜¯å¦éœ€è¦ï¼‰
- âš ï¸ ç¼ºå°‘å•å…ƒæµ‹è¯•
- âš ï¸ é”™è¯¯å¤„ç†å¯ä»¥ä¼˜åŒ–

**å»ºè®®**ï¼š
1. **ç¡®è®¤æƒé™æ£€æŸ¥éœ€æ±‚**ï¼ˆå‚è€ƒ `DeviceHandler`ï¼Œå¯èƒ½ä¸éœ€è¦ï¼‰
2. **åç»­å¤„ç†**ï¼šæ·»åŠ å•å…ƒæµ‹è¯•
3. **å¯é€‰å¤„ç†**ï¼šä¼˜åŒ–é”™è¯¯å¤„ç†å’Œæ—¥å¿—

---

## ğŸ” ä»£ç æ£€æŸ¥ç»“æœ

### å·²ä¿®å¤çš„é—®é¢˜

1. âœ… **é‡å¤çš„å‡½æ•°å®šä¹‰**
   - é—®é¢˜ï¼š`parseIntQuery` å‡½æ•°å®šä¹‰äº†ä¸¤æ¬¡ï¼ˆ312-323è¡Œå’Œ338-349è¡Œï¼‰
   - ä¿®å¤ï¼šåˆ é™¤é‡å¤çš„å®šä¹‰

2. âœ… **ç¼ºå°‘ import**
   - é—®é¢˜ï¼šä½¿ç”¨äº† `context`ã€`database/sql`ã€`fmt`ï¼Œä½†æ²¡æœ‰ import
   - ä¿®å¤ï¼šæ·»åŠ  import

### å¾…ç¡®è®¤çš„é—®é¢˜

1. â“ **æƒé™æ£€æŸ¥**
   - é—®é¢˜ï¼šæ˜¯å¦éœ€è¦æƒé™æ£€æŸ¥ï¼Ÿ
   - å‚è€ƒï¼š`DeviceHandler` æ²¡æœ‰æƒé™æ£€æŸ¥
   - å»ºè®®ï¼šä¿æŒä¸€è‡´æ€§ï¼Œå¯èƒ½ä¸éœ€è¦

### å¾…å®ç°çš„åŠŸèƒ½

1. â³ **å•å…ƒæµ‹è¯•**
2. â³ **é”™è¯¯å¤„ç†ä¼˜åŒ–**
3. â³ **æ—¥å¿—ä¼˜åŒ–**
4. â³ **æ–‡æ¡£å®Œå–„**

