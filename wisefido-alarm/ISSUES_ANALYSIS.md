# wisefido-alarm é—®é¢˜åˆ†æžï¼ˆTODOã€æƒé™ã€åˆ†å±‚ï¼‰

## ðŸ“‹ æ£€æŸ¥ç»“æžœæ€»ç»“

### âœ… æž¶æž„åˆ†å±‚

**å½“å‰åˆ†å±‚ç»“æž„**ï¼š
```
main.go
    â†“
AlarmService (service/alarm.go)
    â”œâ”€ CacheConsumer (consumer/cache_consumer.go)
    â”œâ”€ Evaluator (evaluator/evaluator.go)
    â”‚   â”œâ”€ Event1Evaluator
    â”‚   â”œâ”€ Event2Evaluator
    â”‚   â”œâ”€ Event3Evaluator
    â”‚   â””â”€ Event4Evaluator
    â””â”€ Repositories
        â”œâ”€ AlarmEventsRepository
        â”œâ”€ CardRepository
        â”œâ”€ DeviceRepository
        â””â”€ ...
```

**åˆ†å±‚é—®é¢˜**ï¼š
- âœ… **Repository å±‚**ï¼šå·²å®žçŽ°ï¼Œç»“æž„æ¸…æ™°
- âœ… **Consumer å±‚**ï¼šå·²å®žçŽ°ï¼Œè´Ÿè´£è¯»å– Redis ç¼“å­˜
- âœ… **Evaluator å±‚**ï¼šå·²å®žçŽ°ï¼Œè´Ÿè´£æŠ¥è­¦è§„åˆ™è¯„ä¼°
- âœ… **Service å±‚**ï¼šå·²å®žçŽ°ï¼Œæ•´åˆå„å±‚
- âš ï¸ **Handler å±‚**ï¼š**ç¼ºå¤±** - `wisefido-alarm` æ²¡æœ‰ HTTP Handler

**å…³é”®å‘çŽ°**ï¼š
- `wisefido-alarm` æ˜¯ä¸€ä¸ª**åŽå°æœåŠ¡**ï¼ˆè½®è¯¢æ¨¡å¼ï¼‰ï¼Œä¸æ˜¯ HTTP API æœåŠ¡
- `AlarmEventService` åœ¨ `wisefido-data` ä¸­å®žçŽ°ï¼Œç”¨äºŽ HTTP API
- `wisefido-alarm` çš„ `AlarmService` æ˜¯åŽå°è¯„ä¼°æœåŠ¡ï¼Œä¸æ˜¯ HTTP æœåŠ¡

---

## â³ TODO é—®é¢˜

### 1. Evaluator å±‚çš„äº‹ä»¶è¯„ä¼°é€»è¾‘ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

#### äº‹ä»¶1ï¼šåºŠä¸Šè·Œè½æ£€æµ‹ (`event1_bed_fall.go`)

**TODO é¡¹**ï¼š
- âš ï¸ **TODO: å®žçŽ°å®Œæ•´çš„äº‹ä»¶1é€»è¾‘**ï¼ˆç¬¬32è¡Œï¼‰
- âš ï¸ **TODO: å®žçŽ°å®Œæ•´çš„çŠ¶æ€ç®¡ç†å’Œå®šæ—¶å™¨é€»è¾‘**ï¼ˆç¬¬54è¡Œï¼‰
- âš ï¸ **TODO: éœ€è¦æ£€æŸ¥ postures ä¸­æ˜¯å¦æœ‰ç§»åŠ¨çš„ track_id**ï¼ˆç¬¬79è¡Œï¼‰
- âš ï¸ **TODO: æ£€æŸ¥ä½ç½®æ˜¯å¦å˜åŒ–ï¼ˆéœ€è¦åŽ†å²ä½ç½®æ•°æ®ï¼‰**ï¼ˆç¬¬82è¡Œï¼‰

**å½“å‰çŠ¶æ€**ï¼š
- âœ… åŸºç¡€æ¡†æž¶å·²å®žçŽ°
- âœ… é€€å‡ºæ¡ä»¶æ£€æŸ¥å·²å®žçŽ°ï¼ˆç®€åŒ–ç‰ˆï¼‰
- âœ… çŠ¶æ€ç®¡ç†å‡½æ•°å·²å®žçŽ°ï¼ˆ`getEvent1State`, `setEvent1State`ï¼‰
- âŒ å®Œæ•´çš„çŠ¶æ€ç®¡ç†å’Œå®šæ—¶å™¨é€»è¾‘æœªå®žçŽ°
- âŒ ä½ç½®å˜åŒ–æ£€æµ‹æœªå®žçŽ°

**éœ€è¦å®žçŽ°**ï¼š
1. çŠ¶æ€ç®¡ç†ï¼ˆlyingåŸºçº¿ã€ç¦»åºŠæ—¶é—´ã€track_idçŠ¶æ€ï¼‰
2. å®šæ—¶å™¨ï¼ˆT0+5ç§’ã€T0+60ç§’ã€T0+120ç§’ï¼‰
3. é€€å‡ºæ¡ä»¶æ£€æŸ¥ï¼ˆæŒç»­æ£€æŸ¥ï¼‰
4. å±é™©æƒ…å†µæ£€æµ‹ï¼ˆtrack_idçªç„¶æ¶ˆå¤±ï¼‰

---

#### äº‹ä»¶2ï¼šSleepadå¯é æ€§åˆ¤æ–­ (`event2_sleepad_reliability.go`)

**TODO é¡¹**ï¼š
- âš ï¸ **TODO: å®žçŽ°å®Œæ•´çš„äº‹ä»¶2é€»è¾‘**ï¼ˆç¬¬26è¡Œï¼‰
- âš ï¸ **TODO: éœ€è¦æŸ¥è¯¢å¡ç‰‡ç»‘å®šçš„è®¾å¤‡ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ Radar è®¾å¤‡**ï¼ˆç¬¬42è¡Œï¼‰

**å½“å‰çŠ¶æ€**ï¼š
- âœ… åŸºç¡€æ¡†æž¶å·²å®žçŽ°
- âŒ æ ¸æŸ¥1ï¼ˆå‰ç½®æ¡ä»¶æ£€æŸ¥ï¼‰æœªå®žçŽ°
- âŒ åˆ†æ”¯åˆ¤æ–­ï¼ˆåˆ†æ”¯Aå’Œåˆ†æ”¯Bï¼‰æœªå®žçŽ°
- âŒ æ ¸æŸ¥2å’Œæ ¸æŸ¥3æœªå®žçŽ°

**éœ€è¦å®žçŽ°**ï¼š
1. æ ¸æŸ¥1ï¼ˆå‰ç½®æ¡ä»¶æ£€æŸ¥ï¼‰
2. åˆ†æ”¯åˆ¤æ–­ï¼ˆåˆ†æ”¯Aå’Œåˆ†æ”¯Bï¼‰
3. æ ¸æŸ¥2å’Œæ ¸æŸ¥3

---

#### äº‹ä»¶3ï¼šBathroomå¯ç–‘è·Œå€’æ£€æµ‹ (`event3_bathroom_fall.go`)

**TODO é¡¹**ï¼š
- âš ï¸ **TODO: å®žçŽ°å®Œæ•´çš„äº‹ä»¶3é€»è¾‘**ï¼ˆç¬¬27è¡Œï¼‰
- âš ï¸ **TODO: éœ€è¦æ£€æŸ¥ postures ä¸­çš„å§¿æ€ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯ç«™ç«‹çŠ¶æ€**ï¼ˆç¬¬46è¡Œï¼‰

**å½“å‰çŠ¶æ€**ï¼š
- âœ… åŸºç¡€æ¡†æž¶å·²å®žçŽ°
- âœ… å«ç”Ÿé—´æ£€æµ‹å·²å®žçŽ°ï¼ˆ`roomRepo.IsBathroom`ï¼‰
- âŒ ç«™ç«‹çŠ¶æ€æ£€æµ‹æœªå®žçŽ°
- âŒ ä½ç½®å˜åŒ–æ£€æµ‹æœªå®žçŽ°
- âŒ å•äººæ£€æµ‹æœªå®žçŽ°

**éœ€è¦å®žçŽ°**ï¼š
1. ç«™ç«‹çŠ¶æ€æ£€æµ‹ï¼ˆæ£€æŸ¥ postures ä¸­çš„å§¿æ€ï¼‰
2. ä½ç½®å˜åŒ–æ£€æµ‹ï¼ˆä½ç½®å˜åŒ–å°äºŽ10cmï¼Œè¶…è¿‡10åˆ†é’Ÿï¼‰
3. å•äººæ£€æµ‹ï¼ˆé›·è¾¾æ£€æµ‹èŒƒå›´å†…ä»…1äººï¼‰

---

#### äº‹ä»¶4ï¼šé›·è¾¾æ£€æµ‹åˆ°äººçªç„¶æ¶ˆå¤± (`event4_sudden_disappear.go`)

**TODO é¡¹**ï¼š
- âš ï¸ **TODO: å®žçŽ°å®Œæ•´çš„äº‹ä»¶4é€»è¾‘**ï¼ˆç¬¬25è¡Œï¼‰
- âš ï¸ **TODO: éœ€è¦ç»´æŠ¤ track_id çš„åŽ†å²çŠ¶æ€ï¼Œæ£€æµ‹æ˜¯å¦çªç„¶æ¶ˆå¤±**ï¼ˆç¬¬30è¡Œï¼‰
- âš ï¸ **TODO: éœ€è¦ç»´æŠ¤åŽ†å²é«˜åº¦æ•°æ®ï¼Œæ£€æµ‹é«˜åº¦å˜åŒ–**ï¼ˆç¬¬34è¡Œï¼‰

**å½“å‰çŠ¶æ€**ï¼š
- âœ… åŸºç¡€æ¡†æž¶å·²å®žçŽ°
- âŒ track_id åŽ†å²çŠ¶æ€ç®¡ç†æœªå®žçŽ°
- âŒ è´¨å¿ƒé™ä½Žæ£€æµ‹æœªå®žçŽ°
- âŒ 5åˆ†é’Ÿæ— æ´»åŠ¨æ£€æµ‹æœªå®žçŽ°

**éœ€è¦å®žçŽ°**ï¼š
1. track_id åŽ†å²çŠ¶æ€ç®¡ç†
2. è´¨å¿ƒé™ä½Žæ£€æµ‹ï¼ˆé«˜åº¦é™ä½Žè¶…è¿‡60cmï¼‰
3. 5åˆ†é’Ÿæ— æ´»åŠ¨æ£€æµ‹

---

## ðŸ” æƒé™é—®é¢˜

### 1. AlarmEventService æƒé™æ£€æŸ¥

**ä½ç½®**ï¼š`wisefido-data/internal/service/alarm_event_service.go`

**å½“å‰çŠ¶æ€**ï¼š
- âœ… `HandleAlarmEvent` æ–¹æ³•æœ‰æƒé™æ£€æŸ¥ï¼ˆ`checkHandlePermission`ï¼‰
- âœ… æƒé™æ£€æŸ¥é€»è¾‘ï¼š
  - Facility ç±»åž‹å¡ç‰‡ï¼šåªæœ‰ Nurse æˆ– Caregiver å¯ä»¥å¤„ç†
  - Home ç±»åž‹å¡ç‰‡ï¼šæ‰€æœ‰è§’è‰²éƒ½å¯ä»¥å¤„ç†

**é—®é¢˜**ï¼š
- âš ï¸ **æƒé™æ£€æŸ¥ä¸å®Œæ•´**ï¼šåªæ£€æŸ¥äº† Facility/Home ç±»åž‹ï¼Œæ²¡æœ‰æ£€æŸ¥ï¼š
  - `assigned_only` æƒé™ï¼ˆCaregiver/Nurse åªèƒ½å¤„ç†åˆ†é…çš„ä½æˆ·ï¼‰
  - `branch_only` æƒé™ï¼ˆManager åªèƒ½å¤„ç†åŒåˆ†æ”¯çš„ä½æˆ·ï¼‰

**éœ€è¦æ”¹è¿›**ï¼š
1. æ·»åŠ  `assigned_only` æƒé™æ£€æŸ¥ï¼ˆå‚è€ƒ `ResidentService`ï¼‰
2. æ·»åŠ  `branch_only` æƒé™æ£€æŸ¥ï¼ˆå‚è€ƒ `ResidentService`ï¼‰
3. ç»Ÿä¸€æƒé™æ£€æŸ¥é€»è¾‘ï¼ˆä¸Ž `SleepaceReportHandler` ä¿æŒä¸€è‡´ï¼‰

---

### 2. wisefido-alarm æœåŠ¡æƒé™

**ä½ç½®**ï¼š`wisefido-alarm` æœåŠ¡æœ¬èº«

**å½“å‰çŠ¶æ€**ï¼š
- âœ… `wisefido-alarm` æ˜¯åŽå°æœåŠ¡ï¼Œä¸éœ€è¦ HTTP æƒé™æ£€æŸ¥
- âœ… æœåŠ¡çº§åˆ«çš„æƒé™é€šè¿‡ `TENANT_ID` çŽ¯å¢ƒå˜é‡æŽ§åˆ¶

**ç»“è®º**ï¼š
- âœ… **æ— æƒé™é—®é¢˜** - åŽå°æœåŠ¡ä¸éœ€è¦ HTTP æƒé™æ£€æŸ¥

---

## ðŸ—ï¸ åˆ†å±‚é—®é¢˜

### 1. Service å±‚èŒè´£ä¸æ¸…

**é—®é¢˜**ï¼š
- âš ï¸ `AlarmService` (service/alarm.go) å’Œ `AlarmEventService` (service/alarm_event_service.go) èŒè´£é‡å 
- âš ï¸ `AlarmService` æ˜¯åŽå°è¯„ä¼°æœåŠ¡ï¼Œ`AlarmEventService` æ˜¯ HTTP API æœåŠ¡

**å½“å‰æž¶æž„**ï¼š
```
wisefido-alarm/
  â””â”€ service/
      â”œâ”€ alarm.go              â† åŽå°è¯„ä¼°æœåŠ¡ï¼ˆè½®è¯¢æ¨¡å¼ï¼‰
      â””â”€ alarm_event_service.go â† HTTP API æœåŠ¡ï¼ˆæŸ¥è¯¢ã€å¤„ç†æŠ¥è­¦äº‹ä»¶ï¼‰
```

**é—®é¢˜åˆ†æž**ï¼š
- `AlarmEventService` åº”è¯¥åœ¨ `wisefido-data` ä¸­ï¼ˆå·²å®žçŽ°ï¼‰
- `AlarmService` åº”è¯¥åœ¨ `wisefido-alarm` ä¸­ï¼ˆå·²å®žçŽ°ï¼‰
- âœ… **æž¶æž„æ­£ç¡®** - ä¸¤ä¸ªæœåŠ¡èŒè´£åˆ†ç¦»

**å»ºè®®**ï¼š
- âœ… **ä¿æŒçŽ°çŠ¶** - ä¸¤ä¸ªæœåŠ¡èŒè´£åˆ†ç¦»æ˜¯æ­£ç¡®çš„

---

### 2. Repository å±‚è·¨æœåŠ¡ä½¿ç”¨

**é—®é¢˜**ï¼š
- âš ï¸ `AlarmEventService` åœ¨ `wisefido-data` ä¸­ï¼Œä½†ä½¿ç”¨äº† `wisefido-alarm` çš„ Repository
- âš ï¸ è¿™å¯èƒ½å¯¼è‡´è·¨æ¨¡å—ä¾èµ–é—®é¢˜

**å½“å‰å®žçŽ°**ï¼š
- `wisefido-data` ä¸­çš„ `AlarmEventService` ä½¿ç”¨è‡ªå·±çš„ Repositoryï¼ˆ`wisefido-data/internal/repository/alarm_events_repo.go`ï¼‰
- `wisefido-alarm` ä¸­çš„ `AlarmEventsRepository` æ˜¯ç‹¬ç«‹çš„å®žçŽ°

**ç»“è®º**ï¼š
- âœ… **æ— é—®é¢˜** - ä¸¤ä¸ªæœåŠ¡å„è‡ªç»´æŠ¤è‡ªå·±çš„ Repository å®žçŽ°

---

### 3. Handler å±‚ç¼ºå¤±

**é—®é¢˜**ï¼š
- âš ï¸ `wisefido-alarm` æ²¡æœ‰ HTTP Handler å±‚
- âš ï¸ HTTP API åœ¨ `wisefido-data` ä¸­å®žçŽ°

**å½“å‰æž¶æž„**ï¼š
```
wisefido-alarm/
  â””â”€ åŽå°æœåŠ¡ï¼ˆè½®è¯¢æ¨¡å¼ï¼Œæ—  HTTP APIï¼‰

wisefido-data/
  â””â”€ HTTP APIï¼ˆæŸ¥è¯¢ã€å¤„ç†æŠ¥è­¦äº‹ä»¶ï¼‰
```

**ç»“è®º**ï¼š
- âœ… **æž¶æž„æ­£ç¡®** - `wisefido-alarm` æ˜¯åŽå°æœåŠ¡ï¼Œä¸éœ€è¦ HTTP Handler
- âœ… HTTP API åœ¨ `wisefido-data` ä¸­å®žçŽ°æ˜¯æ­£ç¡®çš„

---

## ðŸ“ å¾…å¤„ç†é—®é¢˜æ¸…å•

### é«˜ä¼˜å…ˆçº§

1. **Evaluator å±‚äº‹ä»¶è¯„ä¼°é€»è¾‘**
   - [ ] äº‹ä»¶1ï¼šå®Œæ•´çš„çŠ¶æ€ç®¡ç†å’Œå®šæ—¶å™¨é€»è¾‘
   - [ ] äº‹ä»¶2ï¼šæ ¸æŸ¥1ã€åˆ†æ”¯åˆ¤æ–­ã€æ ¸æŸ¥2å’Œæ ¸æŸ¥3
   - [ ] äº‹ä»¶3ï¼šç«™ç«‹çŠ¶æ€æ£€æµ‹ã€ä½ç½®å˜åŒ–æ£€æµ‹ã€å•äººæ£€æµ‹
   - [ ] äº‹ä»¶4ï¼štrack_id åŽ†å²çŠ¶æ€ç®¡ç†ã€è´¨å¿ƒé™ä½Žæ£€æµ‹ã€5åˆ†é’Ÿæ— æ´»åŠ¨æ£€æµ‹

2. **AlarmEventService æƒé™æ£€æŸ¥**
   - [ ] æ·»åŠ  `assigned_only` æƒé™æ£€æŸ¥
   - [ ] æ·»åŠ  `branch_only` æƒé™æ£€æŸ¥
   - [ ] ç»Ÿä¸€æƒé™æ£€æŸ¥é€»è¾‘ï¼ˆä¸Ž `SleepaceReportHandler` ä¿æŒä¸€è‡´ï¼‰

### ä¸­ä¼˜å…ˆçº§

3. **é…ç½®å’Œä¼˜åŒ–**
   - [ ] æ·»åŠ æ›´å¤šé…ç½®é¡¹ï¼ˆäº‹ä»¶1-4çš„é˜ˆå€¼ã€æ—¶é—´çª—å£ç­‰ï¼‰
   - [ ] ä¼˜åŒ– `GetAllCardIDs` æ–¹æ³•ï¼ˆä»Ž PostgreSQL æŸ¥è¯¢ï¼Œè€Œä¸æ˜¯æ‰«æ Redisï¼‰
   - [ ] æ·»åŠ æŒ‡æ ‡ç›‘æŽ§ï¼ˆå¤„ç†é€Ÿåº¦ã€æŠ¥è­¦æ•°é‡ç­‰ï¼‰

### ä½Žä¼˜å…ˆçº§

4. **æµ‹è¯•**
   - [ ] æ·»åŠ  Evaluator å±‚å•å…ƒæµ‹è¯•
   - [ ] æ·»åŠ  Service å±‚é›†æˆæµ‹è¯•
   - [ ] æ·»åŠ ç«¯åˆ°ç«¯æµ‹è¯•

---

## ðŸŽ¯ å»ºè®®çš„ä¿®å¤é¡ºåº

### ç¬¬ä¸€æ­¥ï¼šä¿®å¤æƒé™æ£€æŸ¥ï¼ˆæœ€é‡è¦ï¼‰

**æ–‡ä»¶**ï¼š`wisefido-data/internal/service/alarm_event_service.go`

**éœ€è¦ä¿®æ”¹**ï¼š
1. `HandleAlarmEvent` æ–¹æ³•
2. æ·»åŠ  `assigned_only` æƒé™æ£€æŸ¥
3. æ·»åŠ  `branch_only` æƒé™æ£€æŸ¥
4. å‚è€ƒ `SleepaceReportHandler` çš„æƒé™æ£€æŸ¥å®žçŽ°

---

### ç¬¬äºŒæ­¥ï¼šå®Œå–„ Evaluator å±‚äº‹ä»¶è¯„ä¼°é€»è¾‘

**æ–‡ä»¶**ï¼š
- `wisefido-alarm/internal/evaluator/event1_bed_fall.go`
- `wisefido-alarm/internal/evaluator/event2_sleepad_reliability.go`
- `wisefido-alarm/internal/evaluator/event3_bathroom_fall.go`
- `wisefido-alarm/internal/evaluator/event4_sudden_disappear.go`

**ä¼˜å…ˆçº§**ï¼š
1. äº‹ä»¶1ï¼ˆåºŠä¸Šè·Œè½æ£€æµ‹ï¼‰- æœ€å¤æ‚ï¼Œæœ€é‡è¦
2. äº‹ä»¶3ï¼ˆBathroomå¯ç–‘è·Œå€’æ£€æµ‹ï¼‰- å®‰å…¨ç›¸å…³
3. äº‹ä»¶4ï¼ˆäººçªç„¶æ¶ˆå¤±ï¼‰- å®‰å…¨ç›¸å…³
4. äº‹ä»¶2ï¼ˆSleepadå¯é æ€§åˆ¤æ–­ï¼‰- ç›¸å¯¹ç®€å•

---

## âœ… æ€»ç»“

### æž¶æž„åˆ†å±‚

- âœ… **Repository å±‚**ï¼šç»“æž„æ¸…æ™°ï¼Œæ— é—®é¢˜
- âœ… **Consumer å±‚**ï¼šèŒè´£æ˜Žç¡®ï¼Œæ— é—®é¢˜
- âœ… **Evaluator å±‚**ï¼šæ¡†æž¶å·²å®žçŽ°ï¼Œé€»è¾‘å¾…å®Œå–„
- âœ… **Service å±‚**ï¼šèŒè´£åˆ†ç¦»æ­£ç¡®ï¼ˆåŽå°æœåŠ¡ vs HTTP API æœåŠ¡ï¼‰
- âœ… **Handler å±‚**ï¼šHTTP API åœ¨ `wisefido-data` ä¸­å®žçŽ°ï¼Œæž¶æž„æ­£ç¡®

### æƒé™é—®é¢˜

- âš ï¸ **AlarmEventService æƒé™æ£€æŸ¥ä¸å®Œæ•´**ï¼š
  - ç¼ºå°‘ `assigned_only` æƒé™æ£€æŸ¥
  - ç¼ºå°‘ `branch_only` æƒé™æ£€æŸ¥
  - éœ€è¦ä¸Ž `SleepaceReportHandler` ä¿æŒä¸€è‡´

### TODO é—®é¢˜

- âš ï¸ **Evaluator å±‚äº‹ä»¶è¯„ä¼°é€»è¾‘æœªå®Œæˆ**ï¼š
  - äº‹ä»¶1-4 éƒ½æœ‰ TODOï¼Œéœ€è¦å®žçŽ°å®Œæ•´çš„è¯„ä¼°é€»è¾‘
  - ä¼˜å…ˆçº§ï¼šäº‹ä»¶1 > äº‹ä»¶3 > äº‹ä»¶4 > äº‹ä»¶2

---

## ðŸ”— ç›¸å…³æ–‡æ¡£

- `SERVICE_LAYER_COMPLETE_DESIGN.md` - Service å±‚å®Œæ•´è®¾è®¡
- `IMPLEMENTATION_SUMMARY.md` - å®žçŽ°æ€»ç»“
- `REPOSITORY_LAYER_SUMMARY.md` - Repository å±‚æ€»ç»“

