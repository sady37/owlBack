# RolePermission Service vs æ—§ Handler ä¸šåŠ¡é€»è¾‘å¯¹æ¯”

## ğŸ“‹ å¯¹æ¯”åˆ†æ

### 1. GET /admin/api/v1/role-permissions å¯¹æ¯”

#### æ—§ Handler é€»è¾‘ï¼ˆadmin_role_permissions_handlers.go:14-85ï¼‰

**å…³é”®ä¸šåŠ¡é€»è¾‘**ï¼š
1. âœ… **tenant_id å¤„ç†**ï¼š
   - ä½¿ç”¨ SystemTenantID()ï¼ˆå…¨å±€æƒé™å­˜å‚¨åœ¨ç³»ç»Ÿç§Ÿæˆ·ä¸‹ï¼‰
   - å›ºå®šä½¿ç”¨ç³»ç»Ÿç§Ÿæˆ·

2. âœ… **è¿‡æ»¤é€»è¾‘**ï¼š
   - role_code: å¯é€‰è¿‡æ»¤
   - resource_type: å¯é€‰è¿‡æ»¤
   - permission_type: å¯é€‰è¿‡æ»¤ï¼ˆæ”¯æŒ "read", "create", "update", "delete", "manage"ï¼‰
   - "manage" ç±»å‹ä¸è¿›è¡Œè¿‡æ»¤ï¼ˆè¿”å›æ‰€æœ‰æƒé™ç±»å‹ï¼‰

3. âœ… **æƒé™ç±»å‹è½¬æ¢**ï¼š
   - å‰ç«¯æ ¼å¼ï¼š"read", "create", "update", "delete"
   - æ•°æ®åº“æ ¼å¼ï¼š"R", "C", "U", "D"
   - å“åº”æ—¶è½¬æ¢å›å‰ç«¯æ ¼å¼

4. âœ… **Scope è½¬æ¢**ï¼š
   - æ•°æ®åº“ï¼šassigned_only (bool)
   - å‰ç«¯æ ¼å¼ï¼š"all" æˆ– "assigned_only"
   - å“åº”æ—¶è½¬æ¢

5. âœ… **æ’åºé€»è¾‘**ï¼š
   - æŒ‰ `role_code, resource_type, permission_type` æ’åº

#### æ–° Service é€»è¾‘ï¼ˆrole_permission_service.go:57-91ï¼‰

**å½“å‰å®ç°**ï¼š
1. âœ… **tenant_id å¤„ç†**ï¼šå·²å®ç°ï¼ˆé€šè¿‡ req.TenantIDï¼Œä½†ä¸šåŠ¡è§„åˆ™é™åˆ¶ä¸º SystemTenantIDï¼‰
2. âœ… **è¿‡æ»¤é€»è¾‘**ï¼šå·²å®ç°ï¼ˆé€šè¿‡ Repository çš„ RolePermissionsFilterï¼‰
3. âœ… **æƒé™ç±»å‹è½¬æ¢**ï¼šå·²å®ç°ï¼ˆpermissionTypeToDB / permissionTypeFromDBï¼‰
4. âœ… **Scope è½¬æ¢**ï¼šå·²å®ç°ï¼ˆpermissionToItem æ–¹æ³•ï¼‰
5. âœ… **æ’åºé€»è¾‘**ï¼šå·²å®ç°ï¼ˆåœ¨ Repository å±‚å¤„ç†ï¼‰

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… æ‰€æœ‰ä¸šåŠ¡é€»è¾‘ç‚¹éƒ½å·²è¦†ç›–
- âœ… é€»è¾‘ä¸€è‡´

---

### 2. POST /admin/api/v1/role-permissions å¯¹æ¯”

#### æ—§ Handler é€»è¾‘ï¼ˆadmin_role_permissions_handlers.go:88-150ï¼‰

**å…³é”®ä¸šåŠ¡é€»è¾‘**ï¼š
1. âœ… **æƒé™æ£€æŸ¥**ï¼š
   - åªæœ‰ System tenant çš„ SystemAdmin å¯ä»¥ä¿®æ”¹å…¨å±€æƒé™
   - æ£€æŸ¥ tenantID == SystemTenantID() å’Œ X-User-Role == "SystemAdmin"

2. âœ… **å‚æ•°éªŒè¯**ï¼š
   - role_code, resource_type, permission_type å¿…å¡«
   - permission_type æ”¯æŒ "read", "create", "update", "delete", "manage"
   - "manage" ç±»å‹éœ€è¦å±•å¼€ä¸º R, C, U, D

3. âœ… **æƒé™ç±»å‹è½¬æ¢**ï¼š
   - å‰ç«¯æ ¼å¼ â†’ æ•°æ®åº“æ ¼å¼
   - "manage" â†’ R, C, U, Dï¼ˆå±•å¼€ï¼‰

4. âœ… **Scope è½¬æ¢**ï¼š
   - å‰ç«¯æ ¼å¼ï¼š"all" æˆ– "assigned_only"
   - æ•°æ®åº“æ ¼å¼ï¼šassigned_only (bool)

5. âœ… **UPSERT è¯­ä¹‰**ï¼š
   - ä½¿ç”¨ `INSERT ... ON CONFLICT DO UPDATE`
   - å¦‚æœå·²å­˜åœ¨åˆ™æ›´æ–°

#### æ–° Service é€»è¾‘ï¼ˆrole_permission_service.go:93-150ï¼‰

**å½“å‰å®ç°**ï¼š
1. âœ… **æƒé™æ£€æŸ¥**ï¼šå·²å®ç°ï¼ˆåœ¨ Handler å±‚æ£€æŸ¥ï¼ŒService å±‚æ¥æ”¶ UserRoleï¼‰
2. âœ… **å‚æ•°éªŒè¯**ï¼šå·²å®ç°ï¼ˆrole_code, resource_type, permission_type å¿…å¡«ï¼‰
3. âœ… **æƒé™ç±»å‹è½¬æ¢**ï¼šå·²å®ç°ï¼ˆpermissionTypeToDBï¼‰
4. âœ… **Scope è½¬æ¢**ï¼šå·²å®ç°ï¼ˆassigned_only â†” "all"/"assigned_only"ï¼‰
5. âœ… **UPSERT è¯­ä¹‰**ï¼šå·²å®ç°ï¼ˆé€šè¿‡ Repository çš„ CreatePermissionï¼‰

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… æ‰€æœ‰ä¸šåŠ¡é€»è¾‘ç‚¹éƒ½å·²è¦†ç›–
- âœ… é€»è¾‘ä¸€è‡´

---

### 3. POST /admin/api/v1/role-permissions/batch å¯¹æ¯”

#### æ—§ Handler é€»è¾‘ï¼ˆadmin_role_permissions_handlers.go:152-250ï¼‰

**å…³é”®ä¸šåŠ¡é€»è¾‘**ï¼š
1. âœ… **æƒé™æ£€æŸ¥**ï¼š
   - åªæœ‰ System tenant çš„ SystemAdmin å¯ä»¥ä¿®æ”¹å…¨å±€æƒé™

2. âœ… **æ‰¹é‡æ“ä½œé€»è¾‘**ï¼š
   - å…ˆåˆ é™¤è§’è‰²çš„æ‰€æœ‰ç°æœ‰æƒé™
   - ç„¶åæ‰¹é‡åˆ›å»ºæ–°æƒé™
   - ä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§

3. âœ… **"manage" ç±»å‹å±•å¼€**ï¼š
   - å¦‚æœ permission_type ä¸º "manage"ï¼Œå±•å¼€ä¸º R, C, U, D

4. âœ… **é”™è¯¯å¤„ç†**ï¼š
   - å¦‚æœéƒ¨åˆ†æƒé™åˆ›å»ºå¤±è´¥ï¼Œè¿”å›éƒ¨åˆ†æˆåŠŸçš„ç»“æœ

#### æ–° Service é€»è¾‘ï¼ˆrole_permission_service.go:152-220ï¼‰

**å½“å‰å®ç°**ï¼š
1. âœ… **æƒé™æ£€æŸ¥**ï¼šå·²å®ç°ï¼ˆåœ¨ Handler å±‚æ£€æŸ¥ï¼‰
2. âœ… **æ‰¹é‡æ“ä½œé€»è¾‘**ï¼šå·²å®ç°ï¼ˆBatchCreatePermissions æ–¹æ³•ï¼‰
3. âœ… **"manage" ç±»å‹å±•å¼€**ï¼šå·²å®ç°ï¼ˆexpandPermissionType æ–¹æ³•ï¼‰
4. âœ… **é”™è¯¯å¤„ç†**ï¼šå·²å®ç°ï¼ˆè¿”å›æˆåŠŸæ•°é‡å’Œé”™è¯¯åˆ—è¡¨ï¼‰

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… æ‰€æœ‰ä¸šåŠ¡é€»è¾‘ç‚¹éƒ½å·²è¦†ç›–
- âœ… é€»è¾‘ä¸€è‡´

---

### 4. GET /admin/api/v1/role-permissions/resource-types å¯¹æ¯”

#### æ—§ Handler é€»è¾‘ï¼ˆadmin_role_permissions_handlers.go:252-280ï¼‰

**å…³é”®ä¸šåŠ¡é€»è¾‘**ï¼š
1. âœ… **æŸ¥è¯¢é€»è¾‘**ï¼š
   - æŸ¥è¯¢æ‰€æœ‰æƒé™
   - æå–å”¯ä¸€çš„ resource_type
   - è¿”å›èµ„æºç±»å‹åˆ—è¡¨

#### æ–° Service é€»è¾‘ï¼ˆrole_permission_service.go:222-240ï¼‰

**å½“å‰å®ç°**ï¼š
1. âœ… **æŸ¥è¯¢é€»è¾‘**ï¼šå·²å®ç°ï¼ˆGetResourceTypes æ–¹æ³•ï¼‰
2. âœ… **æå–é€»è¾‘**ï¼šå·²å®ç°ï¼ˆä»æƒé™åˆ—è¡¨ä¸­æå–å”¯ä¸€ resource_typeï¼‰

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… æ‰€æœ‰ä¸šåŠ¡é€»è¾‘ç‚¹éƒ½å·²è¦†ç›–
- âœ… é€»è¾‘ä¸€è‡´

---

### 5. PUT /admin/api/v1/role-permissions/:id å¯¹æ¯”

#### æ—§ Handler é€»è¾‘ï¼ˆadmin_role_permissions_handlers.go:282-320ï¼‰

**å…³é”®ä¸šåŠ¡é€»è¾‘**ï¼š
1. âœ… **æƒé™æ£€æŸ¥**ï¼š
   - åªæœ‰ System tenant çš„ SystemAdmin å¯ä»¥ä¿®æ”¹å…¨å±€æƒé™

2. âœ… **æ›´æ–°é€»è¾‘**ï¼š
   - åªæ›´æ–° scope å’Œ branch_only
   - å…¶ä»–å­—æ®µä¸èƒ½ä¿®æ”¹

#### æ–° Service é€»è¾‘ï¼ˆrole_permission_service.go:242-280ï¼‰

**å½“å‰å®ç°**ï¼š
1. âœ… **æƒé™æ£€æŸ¥**ï¼šå·²å®ç°ï¼ˆåœ¨ Handler å±‚æ£€æŸ¥ï¼‰
2. âœ… **æ›´æ–°é€»è¾‘**ï¼šå·²å®ç°ï¼ˆåªæ›´æ–° assigned_only å’Œ branch_onlyï¼‰

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… æ‰€æœ‰ä¸šåŠ¡é€»è¾‘ç‚¹éƒ½å·²è¦†ç›–
- âœ… é€»è¾‘ä¸€è‡´

---

### 6. PUT /admin/api/v1/role-permissions/:id/status å¯¹æ¯”

#### æ—§ Handler é€»è¾‘ï¼ˆadmin_role_permissions_handlers.go:322-350ï¼‰

**å…³é”®ä¸šåŠ¡é€»è¾‘**ï¼š
1. âœ… **æƒé™æ£€æŸ¥**ï¼š
   - åªæœ‰ System tenant çš„ SystemAdmin å¯ä»¥ä¿®æ”¹å…¨å±€æƒé™

2. âœ… **çŠ¶æ€æ›´æ–°é€»è¾‘**ï¼š
   - is_active = false: åˆ é™¤æƒé™ï¼ˆè®°å½•å­˜åœ¨è¡¨ç¤ºæ¿€æ´»ï¼‰
   - is_active = true: å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå¦‚æœå­˜åœ¨åˆ™ä¸åšä»»ä½•æ“ä½œ

#### æ–° Service é€»è¾‘ï¼ˆrole_permission_service.go:282-300ï¼‰

**å½“å‰å®ç°**ï¼š
1. âœ… **æƒé™æ£€æŸ¥**ï¼šå·²å®ç°ï¼ˆåœ¨ Handler å±‚æ£€æŸ¥ï¼‰
2. âœ… **çŠ¶æ€æ›´æ–°é€»è¾‘**ï¼šå·²å®ç°ï¼ˆé€šè¿‡ DeletePermission æˆ– CreatePermissionï¼‰

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… æ‰€æœ‰ä¸šåŠ¡é€»è¾‘ç‚¹éƒ½å·²è¦†ç›–
- âœ… é€»è¾‘ä¸€è‡´

---

### 7. DELETE /admin/api/v1/role-permissions/:id å¯¹æ¯”

#### æ—§ Handler é€»è¾‘ï¼ˆadmin_role_permissions_handlers.go:352-376ï¼‰

**å…³é”®ä¸šåŠ¡é€»è¾‘**ï¼š
1. âœ… **æƒé™æ£€æŸ¥**ï¼š
   - åªæœ‰ System tenant çš„ SystemAdmin å¯ä»¥ä¿®æ”¹å…¨å±€æƒé™

2. âœ… **åˆ é™¤é€»è¾‘**ï¼š
   - ç›´æ¥ DELETEï¼ˆç‰©ç†åˆ é™¤ï¼‰

#### æ–° Service é€»è¾‘ï¼ˆrole_permission_service.go:302-320ï¼‰

**å½“å‰å®ç°**ï¼š
1. âœ… **æƒé™æ£€æŸ¥**ï¼šå·²å®ç°ï¼ˆåœ¨ Handler å±‚æ£€æŸ¥ï¼‰
2. âœ… **åˆ é™¤é€»è¾‘**ï¼šå·²å®ç°ï¼ˆè°ƒç”¨ Repository çš„ DeletePermissionï¼‰

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… æ‰€æœ‰ä¸šåŠ¡é€»è¾‘ç‚¹éƒ½å·²è¦†ç›–
- âœ… é€»è¾‘ä¸€è‡´

---

## ğŸ“Š å…³é”®å·®å¼‚æ€»ç»“

| åŠŸèƒ½ç‚¹ | æ—§ Handler | æ–° Service | çŠ¶æ€ |
|--------|-----------|-----------|------|
| GET åˆ—è¡¨æŸ¥è¯¢ | âœ… ç›´æ¥ SQL | âœ… é€šè¿‡ Repository | âœ… ä¸€è‡´ |
| POST åˆ›å»ºæƒé™ | âœ… ç›´æ¥ SQL | âœ… é€šè¿‡ Repository | âœ… ä¸€è‡´ |
| POST æ‰¹é‡åˆ›å»º | âœ… ç›´æ¥ SQL + äº‹åŠ¡ | âœ… é€šè¿‡ Repository + äº‹åŠ¡ | âœ… ä¸€è‡´ |
| GET èµ„æºç±»å‹ | âœ… ç›´æ¥ SQL | âœ… é€šè¿‡ Repository | âœ… ä¸€è‡´ |
| PUT æ›´æ–°æƒé™ | âœ… ç›´æ¥ SQL | âœ… é€šè¿‡ Repository | âœ… ä¸€è‡´ |
| PUT æ›´æ–°çŠ¶æ€ | âœ… ç›´æ¥ SQL | âœ… é€šè¿‡ Repository | âœ… ä¸€è‡´ |
| DELETE åˆ é™¤æƒé™ | âœ… ç›´æ¥ SQL | âœ… é€šè¿‡ Repository | âœ… ä¸€è‡´ |
| æƒé™ç±»å‹è½¬æ¢ | âœ… æ‰‹åŠ¨è½¬æ¢ | âœ… ç»Ÿä¸€æ–¹æ³• | âœ… ä¸€è‡´ |
| Scope è½¬æ¢ | âœ… æ‰‹åŠ¨è½¬æ¢ | âœ… ç»Ÿä¸€æ–¹æ³• | âœ… ä¸€è‡´ |

---

## âœ… éªŒè¯ç»“è®º

### ä¸šåŠ¡é€»è¾‘å®Œæ•´æ€§ï¼šâœ… **å®Œå…¨ä¸€è‡´**

1. âœ… **GET æ–¹æ³•**ï¼šæ‰€æœ‰ä¸šåŠ¡é€»è¾‘ç‚¹éƒ½å·²è¦†ç›–
2. âœ… **POST æ–¹æ³•**ï¼šæ‰€æœ‰ä¸šåŠ¡é€»è¾‘ç‚¹éƒ½å·²è¦†ç›–
3. âœ… **POST batch æ–¹æ³•**ï¼šæ‰€æœ‰ä¸šåŠ¡é€»è¾‘ç‚¹éƒ½å·²è¦†ç›–
4. âœ… **GET resource-types æ–¹æ³•**ï¼šæ‰€æœ‰ä¸šåŠ¡é€»è¾‘ç‚¹éƒ½å·²è¦†ç›–
5. âœ… **PUT æ–¹æ³•**ï¼šæ‰€æœ‰ä¸šåŠ¡é€»è¾‘ç‚¹éƒ½å·²è¦†ç›–
6. âœ… **PUT status æ–¹æ³•**ï¼šæ‰€æœ‰ä¸šåŠ¡é€»è¾‘ç‚¹éƒ½å·²è¦†ç›–
7. âœ… **DELETE æ–¹æ³•**ï¼šæ‰€æœ‰ä¸šåŠ¡é€»è¾‘ç‚¹éƒ½å·²è¦†ç›–

### æ”¹è¿›ç‚¹ï¼šâœ… **ä»£ç å¤ç”¨**

- âœ… æ–° Service ä½¿ç”¨ç»Ÿä¸€çš„æ–¹æ³•è¿›è¡Œæƒé™ç±»å‹è½¬æ¢å’Œ Scope è½¬æ¢
- âœ… ä»£ç æ›´æ˜“ç»´æŠ¤

---

## ğŸ¯ æœ€ç»ˆç»“è®º

**âœ… æ–° Service ä¸æ—§ Handler çš„ä¸šåŠ¡é€»è¾‘å®Œå…¨ä¸€è‡´ã€‚**

**âœ… å¯ä»¥å®‰å…¨æ›¿æ¢æ—§ Handler**

