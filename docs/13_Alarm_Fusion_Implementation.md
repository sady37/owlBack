# wisefido-alarm æœåŠ¡å®ç°è®¾è®¡

## ğŸ“‹ æ¦‚è¿°

wisefido-alarm æœåŠ¡è´Ÿè´£å¯¹èåˆåçš„å®æ—¶æ•°æ®è¿›è¡ŒæŠ¥è­¦è§„åˆ™è¯„ä¼°ï¼Œç”ŸæˆæŠ¥è­¦äº‹ä»¶å¹¶æ›´æ–°ç¼“å­˜ã€‚

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. æ•°æ®è¾“å…¥
- **Redis ç¼“å­˜**ï¼š`vital-focus:card:{card_id}:realtime`ï¼ˆèåˆåçš„å®æ—¶æ•°æ®ï¼‰
- **PostgreSQL**ï¼š`alarm_cloud`ï¼ˆç§Ÿæˆ·çº§åˆ«æŠ¥è­¦ç­–ç•¥ï¼‰ã€`alarm_device`ï¼ˆè®¾å¤‡çº§åˆ«æŠ¥è­¦é…ç½®ï¼‰

### 2. æŠ¥è­¦è¯„ä¼°
- **ç”Ÿå‘½ä½“å¾å¼‚å¸¸**ï¼šå¿ƒç‡å¼‚å¸¸ã€å‘¼å¸ç‡å¼‚å¸¸ã€å‘¼å¸æš‚åœ
- **è¡Œä¸ºäº‹ä»¶**ï¼šè·Œå€’ã€ç¦»åºŠã€åºŠä¸Šåèµ·ç­‰
- **è®¾å¤‡çŠ¶æ€**ï¼šè®¾å¤‡ç¦»çº¿ã€ä½ç”µé‡ã€è®¾å¤‡æ•…éšœç­‰

### 3. æ•°æ®è¾“å‡º
- **PostgreSQL**ï¼š`alarm_events` è¡¨ï¼ˆæŠ¥è­¦äº‹ä»¶è®°å½•ï¼‰
- **Redis ç¼“å­˜**ï¼š`vital-focus:card:{card_id}:alarms`ï¼ˆæŠ¥è­¦æ•°æ®ï¼ŒTTL: 30ç§’ï¼‰

## ğŸ“Š æ•°æ®æµ

```
Redis (vital-focus:card:{card_id}:realtime)
    â†“ è¯»å–èåˆåçš„å®æ—¶æ•°æ®
wisefido-alarm æœåŠ¡
    â”œâ”€ è¯»å–æŠ¥è­¦è§„åˆ™ï¼ˆalarm_cloud, alarm_deviceï¼‰
    â”œâ”€ è¯„ä¼°æŠ¥è­¦æ¡ä»¶
    â”œâ”€ ç”ŸæˆæŠ¥è­¦äº‹ä»¶
    â”œâ”€â†’ PostgreSQL (alarm_events)
    â””â”€â†’ Redis (vital-focus:card:{card_id}:alarms)
```

## ğŸ” æŠ¥è­¦è§„åˆ™

### 1. å¿ƒç‡å¼‚å¸¸ï¼ˆHeart Rate, HRï¼‰

**é˜ˆå€¼é…ç½®**ï¼ˆä» `alarm_cloud.conditions.heart_rate` è¯»å–ï¼‰ï¼š
- **EMERGENCY**ï¼š`[0-44]` æˆ– `[116-âˆ]`ï¼ŒæŒç»­ â‰¥ 60ç§’
- **WARNING**ï¼š`[45-54]` æˆ– `[96-115]`ï¼ŒæŒç»­ â‰¥ 300ç§’
- **Normal**ï¼š`[55-95]`

**è¯„ä¼°é€»è¾‘**ï¼š
1. è¯»å–èåˆåçš„å¿ƒç‡å€¼ï¼ˆ`realtime.heart`ï¼‰
2. æ£€æŸ¥æ˜¯å¦åœ¨å¼‚å¸¸èŒƒå›´å†…
3. è®¡ç®—æŒç»­æ—¶é—´ï¼ˆéœ€è¦è¿ç»­æ»¡è¶³æ¡ä»¶ï¼‰
4. å¦‚æœæ»¡è¶³é˜ˆå€¼å’ŒæŒç»­æ—¶é—´ï¼Œç”ŸæˆæŠ¥è­¦äº‹ä»¶

**äº‹ä»¶ç±»å‹**ï¼š
- `Radar_AbnormalHeartRate`ï¼ˆå¦‚æœæ•°æ®æ¥æºæ˜¯ Radarï¼‰
- `SleepPad_AbnormalHeartRate`ï¼ˆå¦‚æœæ•°æ®æ¥æºæ˜¯ Sleepaceï¼‰

### 2. å‘¼å¸ç‡å¼‚å¸¸ï¼ˆRespiratory Rate, RRï¼‰

**é˜ˆå€¼é…ç½®**ï¼ˆä» `alarm_cloud.conditions.respiratory_rate` è¯»å–ï¼‰ï¼š
- **EMERGENCY**ï¼š`[0-7]` æˆ– `[27-âˆ]`ï¼ŒæŒç»­ â‰¥ 60ç§’
- **WARNING**ï¼š`[8-9]` æˆ– `[24-26]`ï¼ŒæŒç»­ â‰¥ 300ç§’
- **Normal**ï¼š`[10-23]`

**è¯„ä¼°é€»è¾‘**ï¼šåŒå¿ƒç‡å¼‚å¸¸

**äº‹ä»¶ç±»å‹**ï¼š
- `Radar_AbnormalRespiratoryRate`ï¼ˆå¦‚æœæ•°æ®æ¥æºæ˜¯ Radarï¼‰
- `SleepPad_AbnormalRespiratoryRate`ï¼ˆå¦‚æœæ•°æ®æ¥æºæ˜¯ Sleepaceï¼‰

### 3. å‘¼å¸æš‚åœï¼ˆApnea Hypopneaï¼‰

**è¯„ä¼°é€»è¾‘**ï¼š
- æ£€æµ‹å‘¼å¸ç‡æ˜¯å¦ä¸º 0 æˆ–æ¥è¿‘ 0
- æŒç»­æ—¶é—´é˜ˆå€¼ï¼ˆä» `alarm_device.monitor_config.alarms.{Radar|SleepPad}_ApneaHypopnea.threshold.duration_sec` è¯»å–ï¼‰

**äº‹ä»¶ç±»å‹**ï¼š
- `Radar_ApneaHypopnea`
- `SleepPad_ApneaHypopnea`

### 4. è·Œå€’ï¼ˆFallï¼‰

**è¯„ä¼°é€»è¾‘**ï¼š
- ä»å§¿æ€æ•°æ®ä¸­æ£€æµ‹è·Œå€’å§¿æ€ï¼ˆ`posture_code` å¯¹åº” SNOMED è·Œå€’ç¼–ç ï¼‰
- éœ€è¦è®¾å¤‡æœ¬åœ°è§¦å‘æˆ–äº‘ç«¯è®¡ç®—

**äº‹ä»¶ç±»å‹**ï¼š
- `Fall`ï¼ˆRadarï¼‰
- `SuspectedFall`ï¼ˆå¯ç–‘è·Œå€’ï¼ŒRadarï¼‰

### 5. ç¦»åºŠï¼ˆLeft Bedï¼‰

**è¯„ä¼°é€»è¾‘**ï¼š
- æ£€æµ‹åºŠçŠ¶æ€å˜åŒ–ï¼ˆ`bed_status` ä» "in bed" å˜ä¸º "out of bed"ï¼‰
- æŒç»­æ—¶é—´é˜ˆå€¼ï¼ˆä» `alarm_device.monitor_config.alarms.{Radar|SleepPad}_LeftBed.threshold.duration_sec` è¯»å–ï¼‰

**äº‹ä»¶ç±»å‹**ï¼š
- `Radar_LeftBed`ï¼ˆRadarï¼‰
- `SleepPad_LeftBed`ï¼ˆSleepaceï¼‰

### 6. è®¾å¤‡çŠ¶æ€æŠ¥è­¦

**è¯„ä¼°é€»è¾‘**ï¼š
- ä»è®¾å¤‡çŠ¶æ€è¡¨æˆ–å®æ—¶æ•°æ®ä¸­æ£€æµ‹è®¾å¤‡çŠ¶æ€
- è®¾å¤‡ç¦»çº¿ã€ä½ç”µé‡ã€è®¾å¤‡æ•…éšœç­‰

**äº‹ä»¶ç±»å‹**ï¼š
- `OfflineAlarm`ï¼ˆè®¾å¤‡ç¦»çº¿ï¼‰
- `LowBattery`ï¼ˆä½ç”µé‡ï¼‰
- `DeviceFailure`ï¼ˆè®¾å¤‡æ•…éšœï¼‰

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. é¡¹ç›®ç»“æ„

```
wisefido-alarm/
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ wisefido-alarm/
â”‚       â””â”€â”€ main.go
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ config.go          # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ realtime_data.go   # å®æ—¶æ•°æ®æ¨¡å‹ï¼ˆå¤ç”¨ sensor-fusionï¼‰
â”‚   â”‚   â”œâ”€â”€ alarm_event.go     # æŠ¥è­¦äº‹ä»¶æ¨¡å‹
â”‚   â”‚   â””â”€â”€ alarm_config.go    # æŠ¥è­¦é…ç½®æ¨¡å‹
â”‚   â”œâ”€â”€ repository/
â”‚   â”‚   â”œâ”€â”€ alarm_cloud.go     # alarm_cloud è¡¨æ“ä½œ
â”‚   â”‚   â”œâ”€â”€ alarm_device.go    # alarm_device è¡¨æ“ä½œ
â”‚   â”‚   â””â”€â”€ alarm_events.go    # alarm_events è¡¨æ“ä½œ
â”‚   â”œâ”€â”€ evaluator/
â”‚   â”‚   â”œâ”€â”€ vital_signs.go     # ç”Ÿå‘½ä½“å¾è¯„ä¼°å™¨
â”‚   â”‚   â”œâ”€â”€ behavior.go        # è¡Œä¸ºäº‹ä»¶è¯„ä¼°å™¨
â”‚   â”‚   â””â”€â”€ device_status.go   # è®¾å¤‡çŠ¶æ€è¯„ä¼°å™¨
â”‚   â”œâ”€â”€ consumer/
â”‚   â”‚   â”œâ”€â”€ cache_consumer.go  # Redis ç¼“å­˜æ¶ˆè´¹è€…
â”‚   â”‚   â””â”€â”€ cache_manager.go   # æŠ¥è­¦ç¼“å­˜ç®¡ç†å™¨
â”‚   â””â”€â”€ service/
â”‚       â””â”€â”€ alarm.go           # æŠ¥è­¦æœåŠ¡ä¸»é€»è¾‘
â””â”€â”€ go.mod
```

### 2. æ ¸å¿ƒç»„ä»¶

#### 2.1 CacheConsumerï¼ˆRedis ç¼“å­˜æ¶ˆè´¹è€…ï¼‰

**èŒè´£**ï¼š
- å®šæœŸè½®è¯¢ Redis ç¼“å­˜ï¼ˆ`vital-focus:card:{card_id}:realtime`ï¼‰
- æˆ–è€…ç›‘å¬ Redis Streams äº‹ä»¶ï¼ˆå¦‚æœ sensor-fusion å‘å¸ƒäº‹ä»¶ï¼‰

**å®ç°æ–¹å¼**ï¼š
- **æ–¹æ¡ˆ A**ï¼šå®šæœŸè½®è¯¢ï¼ˆç®€å•ï¼Œä½†å¯èƒ½æœ‰å»¶è¿Ÿï¼‰
- **æ–¹æ¡ˆ B**ï¼šç›‘å¬ Redis Streamsï¼ˆæ¨èï¼Œå®æ—¶æ€§å¥½ï¼‰

#### 2.2 AlarmEvaluatorï¼ˆæŠ¥è­¦è¯„ä¼°å™¨ï¼‰

**èŒè´£**ï¼š
- è¯„ä¼°ç”Ÿå‘½ä½“å¾å¼‚å¸¸ï¼ˆå¿ƒç‡ã€å‘¼å¸ç‡ï¼‰
- è¯„ä¼°è¡Œä¸ºäº‹ä»¶ï¼ˆè·Œå€’ã€ç¦»åºŠç­‰ï¼‰
- è¯„ä¼°è®¾å¤‡çŠ¶æ€ï¼ˆç¦»çº¿ã€æ•…éšœç­‰ï¼‰

**æ¥å£è®¾è®¡**ï¼š
```go
type AlarmEvaluator interface {
    EvaluateVitalSigns(realtime *RealtimeData, config *AlarmConfig) ([]*AlarmEvent, error)
    EvaluateBehavior(realtime *RealtimeData, config *AlarmConfig) ([]*AlarmEvent, error)
    EvaluateDeviceStatus(deviceID string, config *AlarmConfig) ([]*AlarmEvent, error)
}
```

#### 2.3 CacheManagerï¼ˆæŠ¥è­¦ç¼“å­˜ç®¡ç†å™¨ï¼‰

**èŒè´£**ï¼š
- æ›´æ–° Redis ç¼“å­˜ï¼ˆ`vital-focus:card:{card_id}:alarms`ï¼‰
- è®¡ç®—æŠ¥è­¦ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ€»æœªå¤„ç†æŠ¥è­¦æ•°ã€æœ€æ–°æŠ¥è­¦ç­‰ï¼‰

**ç¼“å­˜ç»“æ„**ï¼š
```json
{
  "total_unhandled_alarms": 2,
  "icon_alarm_color": "red",
  "icon_alarm_level": 1,
  "alarms": [
    {
      "event_id": "...",
      "event_type": "Radar_AbnormalHeartRate",
      "alarm_level": "ALERT",
      "triggered_at": "2025-01-15T10:30:00Z",
      "trigger_data": {
        "heart_rate": 120,
        "threshold": {"min": 116, "max": null},
        "duration_sec": 65
      }
    }
  ]
}
```

## ğŸ”„ å¤„ç†æµç¨‹

### 1. å®æ—¶æ•°æ®æ›´æ–°è§¦å‘

```
1. wisefido-sensor-fusion æ›´æ–° realtime ç¼“å­˜
2. å‘å¸ƒäº‹ä»¶åˆ° Redis Streamsï¼ˆå¯é€‰ï¼‰
3. wisefido-alarm æ¶ˆè´¹äº‹ä»¶æˆ–è½®è¯¢ç¼“å­˜
```

### 2. æŠ¥è­¦è¯„ä¼°æµç¨‹

```
1. è¯»å–å¡ç‰‡çš„æ‰€æœ‰è®¾å¤‡é…ç½®ï¼ˆalarm_deviceï¼‰
2. è¯»å–ç§Ÿæˆ·æŠ¥è­¦ç­–ç•¥ï¼ˆalarm_cloudï¼‰
3. åˆå¹¶é…ç½®ï¼ˆè®¾å¤‡é…ç½®ä¼˜å…ˆï¼‰
4. è¯„ä¼°å„é¡¹æŠ¥è­¦è§„åˆ™ï¼š
   - å¿ƒç‡å¼‚å¸¸
   - å‘¼å¸ç‡å¼‚å¸¸
   - å‘¼å¸æš‚åœ
   - è·Œå€’
   - ç¦»åºŠ
   - è®¾å¤‡çŠ¶æ€
5. ç”ŸæˆæŠ¥è­¦äº‹ä»¶
6. å†™å…¥ PostgreSQLï¼ˆalarm_eventsï¼‰
7. æ›´æ–° Redis ç¼“å­˜ï¼ˆalarmsï¼‰
```

### 3. æŒç»­æ—¶é—´è®¡ç®—

**é—®é¢˜**ï¼šæŠ¥è­¦éœ€è¦æŒç»­ä¸€å®šæ—¶é—´æ‰è§¦å‘ï¼ˆå¦‚å¿ƒç‡å¼‚å¸¸æŒç»­ â‰¥ 60ç§’ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç»´æŠ¤çŠ¶æ€ç¼“å­˜ï¼ˆRedisï¼‰ï¼šè®°å½•æ¯ä¸ªæŠ¥è­¦é¡¹çš„æŒç»­çŠ¶æ€
- çŠ¶æ€ç»“æ„ï¼š`alarm:state:{card_id}:{event_type}` â†’ `{start_time, value, duration_sec}`
- æ¯æ¬¡è¯„ä¼°æ—¶ï¼š
  1. æ£€æŸ¥å½“å‰å€¼æ˜¯å¦æ»¡è¶³æ¡ä»¶
  2. å¦‚æœæ»¡è¶³ï¼Œæ›´æ–°çŠ¶æ€ç¼“å­˜ï¼ˆè®°å½•å¼€å§‹æ—¶é—´ï¼‰
  3. è®¡ç®—æŒç»­æ—¶é—´
  4. å¦‚æœæŒç»­æ—¶é—´ â‰¥ é˜ˆå€¼ï¼Œç”ŸæˆæŠ¥è­¦äº‹ä»¶

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®æ¥æºæ ‡è®°

æŠ¥è­¦äº‹ä»¶éœ€è¦æ ‡è®°æ•°æ®æ¥æºï¼ˆ`trigger_data.source`ï¼‰ï¼š
- å¦‚æœå¿ƒç‡æ¥è‡ª Sleepaceï¼Œäº‹ä»¶ç±»å‹ä¸º `SleepPad_AbnormalHeartRate`
- å¦‚æœå¿ƒç‡æ¥è‡ª Radarï¼Œäº‹ä»¶ç±»å‹ä¸º `Radar_AbnormalHeartRate`

### 2. æŠ¥è­¦çº§åˆ«è®¡ç®—

æœ€ç»ˆæŠ¥è­¦çº§åˆ« = `max(alarm_cloud çº§åˆ«, alarm_device çº§åˆ«)`

### 3. æŠ¥è­¦å»é‡

é¿å…é‡å¤ç”Ÿæˆç›¸åŒçš„æŠ¥è­¦äº‹ä»¶ï¼š
- æ£€æŸ¥æœ€è¿‘ N åˆ†é’Ÿå†…æ˜¯å¦å·²æœ‰ç›¸åŒç±»å‹çš„æŠ¥è­¦
- å¦‚æœå·²æœ‰ï¼Œæ›´æ–°ç°æœ‰æŠ¥è­¦ï¼ˆå»¶é•¿æŒç»­æ—¶é—´ï¼‰è€Œä¸æ˜¯åˆ›å»ºæ–°æŠ¥è­¦

### 4. æŠ¥è­¦è‡ªåŠ¨è§£é™¤

æŸäº›æŠ¥è­¦å¯ä»¥è‡ªåŠ¨è§£é™¤ï¼š
- è®¾å¤‡ç¦»çº¿æŠ¥è­¦ â†’ è®¾å¤‡ä¸Šçº¿ â†’ è‡ªåŠ¨è§£é™¤
- è®¾å¤‡æ•…éšœæŠ¥è­¦ â†’ è®¾å¤‡æ¢å¤ â†’ è‡ªåŠ¨è§£é™¤

**æ³¨æ„**ï¼šç”Ÿå‘½ä½“å¾å¼‚å¸¸ã€è·Œå€’ç­‰æŠ¥è­¦ä¸èƒ½è‡ªåŠ¨è§£é™¤ï¼Œå¿…é¡»äººå·¥å¤„ç†ã€‚

## ğŸš€ å®ç°è®¡åˆ’

1. âœ… åˆ›å»ºé¡¹ç›®ç»“æ„å’Œè®¾è®¡æ–‡æ¡£
2. â³ å®ç°é…ç½®ç®¡ç†å’Œæ•°æ®æ¨¡å‹
3. â³ å®ç° Repository å±‚ï¼ˆæ•°æ®åº“æ“ä½œï¼‰
4. â³ å®ç°æŠ¥è­¦è¯„ä¼°å™¨ï¼ˆç”Ÿå‘½ä½“å¾ã€è¡Œä¸ºã€è®¾å¤‡çŠ¶æ€ï¼‰
5. â³ å®ç° Redis æ¶ˆè´¹è€…å’Œç¼“å­˜ç®¡ç†å™¨
6. â³ å®ç°ä¸»æœåŠ¡é€»è¾‘
7. â³ æµ‹è¯•å’ŒéªŒè¯

