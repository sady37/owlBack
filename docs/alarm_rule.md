# 事件1：防止雷达漏报 - 床上跌落检测

## 目的
防止人从床上跌落，但雷达因误差或干扰未报警。

## 触发条件
- **T0**：sleepad检测到离床事件

## 阶段1：建立lying基线（准备阶段）

### 目的
为跌落检测建立可靠的参考基线

### 记录时机
- 检测到**睡眠状态**时，才记录lying值
- 不是简单的lying姿态，而是睡眠状态（更稳定可靠）

### 记录内容
- `lying_height`：lying时的高度值（作为参考值）
- `lying_position`：lying时的位置
- `lying_time`：lying开始时间

### 关键点
- lying值仅作为**参考值**，主要用于**确认跌落**，而不是否认跌落
- 如果高度降低了（current_height < lying_height），确认跌落
- 如果高度没降低，不能否认跌落（因为高度数据不可靠）

## 阶段2：跌落检测（T0触发）

### T0：sleepad检测到离床事件
- 开始计时，进入可疑跌倒检测流程
- 记录离床时间：left_bed_time = T0

### 退出条件（持续检查）
在整个事件1过程中，**持续检查**以下退出条件，任何时候满足就退出：
- sleepad有HR/RR → 退出（人可能回到床上）
- sleepad有上床事件 → 退出（人回到床上）
- radar检测到在移动 → 退出（人正常离床）

### T0+5秒后：危险情况检测（提前触发）
**开始监控track_id是否消失**

**条件检查**：
- track_id突然消失（没有改变位置，但突然消失）
- 30秒后未出现新的可移动的track

**如果满足**：
- 即刻报跌倒（AI-fall，ALERT级别）

**逻辑**：
- 从T0+5秒开始监控track_id是否消失
- 如果消失且30秒内没有新的可移动track出现，说明很可能是被遮挡或跌落了
- 比等到T0+120秒更及时，能更早发现危险情况

### T0+60秒：可疑跌倒
**条件检查**（T0+60秒时）：
- 如果60秒内没有退出，且满足：
  1. 睡眠板没有呼吸心率（sleepad已确认离床）
  2. 雷达仍显示相同track在床的区域（area_id匹配）

**如果满足**：
- 报可疑跌倒（SuspectedFall，WARNING级别）

**逻辑**：
- 给60秒观察窗口，如果60秒内出现正常情况（有HR/RR、上床事件、移动），退出
- 如果60秒后仍无正常情况，报可疑跌倒

### T0+120秒：确认跌倒（AI-fall）
**条件检查**（T0+120秒时）：
- 如果120秒内没有退出，且满足：
  1. 身高值较床或之前的lying高度降低
     - current_height < bed_height 或
     - current_height < lying_height（如果lying_height存在）
     - lying值仅作为参考，主要用于确认跌落
  2. 人未移动（位置未变化，雷达仍显示在床区域）
  3. track_id仍存在（未消失）

**如果满足**：
- 立即在所在位置报：AI-fall（Fall，ALERT级别）

**逻辑**：
- 高度降低 + sleepad确认离床 + 人未移动 → 确认跌落

## 关键逻辑点

1. **以sleepad为准**：sleepad检测到离床且无心率/呼吸，基本确认人离床了
2. **雷达数据可信度低**：lying是静止状态，雷达不可靠；跌落检测时，雷达显示在床区域可能是静止状态，不可靠
3. **lying值的作用**：仅作为参考值，主要用于确认跌落，不用于否认跌落
4. **退出机制**：如果雷达检测到人离床且有移动，退出事件1
5. **危险情况优先**：track_id突然消失且30秒内未出现新的可移动track，即刻报警，不等待T0+120秒

## 数据存储

- **Redis缓存**：存储track_id状态、时间戳、lying基线数据
- **PostgreSQL**：存储报警事件
- **状态键**：`alarm:state:{card_id}:track_{track_id}:lying_height`

---

# 事件2：Sleepad可靠性判断 - 避免电磁或振动干扰

## 目的
识别sleepad可能受到的电磁或振动干扰，避免误报。

## 触发条件
- **当sleepad检测到呼吸心率时**，进行事件核查

## 核心问题
sleepad可能被电磁或振动干扰，即使床上无人，也可能误报有呼吸心率。

## 执行流程

### 步骤1：核查1（前置条件）
**条件检查**：
- sleepad检测到呼吸心率
- 但sleepad未检测到上床事件

**如果满足**：
- 进入分支判断（不立即给warning）

**如果不满足**（sleepad有上床事件）：
- 退出事件2（正常情况）

### 步骤2：分支判断（先执行）

#### 分支A：床上绑radar（核查2）
**条件检查**：
- 绑到床上的雷达，未检测到区域ID-床有人存在
- 且睡眠板也未检测到有上床事件

**如果满足**：
- error: `Environmental interference`（结束）

#### 分支B：床上未绑但房间内有Radar（核查3）
**条件检查**：
- radar与sleepad均绑在同一room_ID
- 且房间内仅有一床
- 床在雷达的检测区域
- 但雷达检测区域内无人
- 且sleepad有呼吸心率

**如果满足**：
- error: `AI-Environmental interference`（结束）

### 步骤3：如果没有进入分支
**如果分支A和分支B都不满足**：
- warning: `AI-Environmental interference`

## 逻辑结构

```
sleepad检测到呼吸心率
    ↓
核查1：sleepad未检测到上床事件？
    ├─ 是 → 进入分支判断
    │       ├─ 床上绑radar → 核查2 → error: Environmental interference（结束）
    │       ├─ 床上未绑但房间内有Radar → 核查3 → error: AI-Environmental interference（结束）
    │       └─ 都不满足 → warning: AI-Environmental interference
    │
    └─ 否 → 退出事件2（正常情况）
```

## 关键逻辑点

1. **核查1是前置**：必须先检查sleepad是否有上床事件
2. **先检查更严重的情况**：分支判断（error级别）先执行，如果没有进入分支，再给warning
3. **两个分支**：根据radar的绑定情况，执行不同的核查
4. **逻辑清晰**：避免先给warning再覆盖的问题

## 数据存储

- **Redis缓存**：存储sleepad可靠性状态
- **PostgreSQL**：存储报警事件
- **状态键**：`alarm:state:{card_id}:sleeppad_reliability`

---

# 事件3：Bathroom可疑跌倒检测

## 目的
检测卫生间内长时间站立不动，可能是跌倒后无法移动。

## 触发条件
- 在bathroom（卫生间）房间内

## 房间识别
- 通过 `room_name` 或 `unit_name` 中是否包含以下词（不区分大小写）：
  - bathroom
  - restroom
  - toilet

## 条件检查
1. 在bathroom房间内
2. **雷达检测范围内仅1人**
3. 1个人处于**站立状态**（不是坐着）
4. 位置未有变化（位置变化小于10cm，超过10分钟）
5. 房间内仅有1个track_id

## 如果满足
- 在当前位置报：AI-suspected fall（SuspectedFall，WARNING级别）

## 逻辑
- 卫生间是高风险区域
- 如果是**站立状态**且长时间不移动，可能是跌倒后无法移动
- 如果是坐着（坐在马桶上），长时间不动是正常的，不报警
- 雷达检测范围内仅1人，排除多人干扰

## 关键逻辑点

1. **姿态区分**：必须是站立状态，坐着（坐在马桶上）长时间不动是正常的，不报警
2. **位置未变化判断**：位置变化小于10cm算未变化
3. **时间阈值**：10分钟（可配置）
4. **单人检测**：雷达检测范围内仅1人，排除多人干扰

## 数据存储

- **Redis缓存**：存储track_id位置历史
- **PostgreSQL**：存储报警事件
- **状态键**：`alarm:state:{card_id}:track_{track_id}:bathroom_stand`

---

# 事件4：雷达检测到人突然消失

## 目的
检测质心降低 + 突然消失，可能是跌倒。注意：此事件难以确定，因为可能是走进雷达盲区。

## 触发条件
- 雷达检测到质心降低（高度降低）
- 第2秒人消失（track_id在2秒内消失）

## 条件检查
1. 质心降低（高度降低超过60cm，可配置）
2. 第2秒人消失（track_id在2秒内突然消失）
3. 5分钟内无人员活动（未检测到任何人类活动）

## 如果满足
- 在消失位置报：AI-suspected fall（SuspectedFall，WARNING级别）

## 逻辑
- **重点判断**：质心降低 + 第2秒人消失 + 5分钟内无人员活动
- **不确定性说明**：此事件难以确定，因为可能是走进雷达盲区，而非真正跌倒
- **判断依据**：
  - 质心降低：可能是跌倒前的姿态变化
  - 第2秒消失：突然消失，非正常离开
  - 5分钟无活动：确认消失，非短暂遮挡

## 注意事项
- 此事件存在误报风险，因为可能是正常进入盲区
- 需要结合其他传感器数据（如Sleepad）进行综合判断
- 高度阈值可配置（默认60cm，考虑雷达误差30cm+）

## 数据存储

- **Redis缓存**：存储track_id消失前的高度和位置
- **PostgreSQL**：存储报警事件
- **状态键**：`alarm:state:{card_id}:track_{track_id}:sudden_disappear`

